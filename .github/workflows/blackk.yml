name: Fetch Shanxi Multicast to Blacklist

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 09:00 = UTC 01:00
    - cron: '20 1 * * *'
    # åŒ—äº¬æ—¶é—´ 17:00 = UTC 09:00
    - cron: '20 9 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: æŠ“å–ç½‘é¡µå¹¶æå–ç»„æ’­æº
        id: fetch
        run: |
          TARGET_URL="https://my9.ltd/tvsh/?t=multicast&province=sx&isp=all&limit=20&valid=1"
          OUTPUT_FILE="black.yml"
          echo "å¼€å§‹æŠ“å–å±±è¥¿æœ‰æ•ˆç»„æ’­..."

          # ä¸‹è½½ç½‘é¡µ
          HTML_CONTENT=$(curl -s -L "$TARGET_URL" | tr '\n' ' ' | sed 's/<[^>]*>/ /g')

          # æå–æ‰€æœ‰ç¬¦åˆIPåœ°å€æ ¼å¼çš„å­—ç¬¦ä¸²
          echo "$HTML_CONTENT" | grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | sort -u > extracted_ips.txt

          IP_COUNT=$(wc -l < extracted_ips.txt | tr -d ' ')
          echo "å…±æå–åˆ° $IP_COUNT ä¸ªå”¯ä¸€IPåœ°å€ã€‚"

          # åˆ›å»º black.yml æ–‡ä»¶
          echo "# å±±è¥¿ç»„æ’­æºé»‘åå•" > $OUTPUT_FILE
          echo "# è‡ªåŠ¨ç”Ÿæˆäº: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $OUTPUT_FILE
          echo "# æ¥æº: $TARGET_URL" >> $OUTPUT_FILE
          echo "# æ€»æ•°: $IP_COUNT" >> $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE

          # è½¬æ¢ä¸ºIPTVé»‘åå•æ ¼å¼ (ç¤ºä¾‹æ ¼å¼ï¼Œå¯æ ¹æ®ä½ çš„æ’­æ”¾å™¨éœ€æ±‚è°ƒæ•´)
          echo "blacklist:" >> $OUTPUT_FILE
          while read ip; do
            # è¿™é‡Œè½¬æ¢ä¸º rtp:// ç»„æ’­æ ¼å¼ï¼Œç«¯å£é€šå¸¸ä¸º 5140
            echo "  - rtp://$ip:5140" >> $OUTPUT_FILE
          done < extracted_ips.txt

          # ä¹Ÿå¯ä»¥é€‰æ‹©ç›´æ¥è¾“å‡ºIPåˆ—è¡¨æ ¼å¼
          # echo "# çº¯IPåˆ—è¡¨" >> $OUTPUT_FILE
          # while read ip; do
          #   echo "$ip" >> $OUTPUT_FILE
          # done < extracted_ips.txt

          echo "æå–çš„IPåˆ—è¡¨é¢„è§ˆ (å‰5ä¸ª):"
          head -5 extracted_ips.txt

          echo "black.yml æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -10 $OUTPUT_FILE

          echo "ip_count=$IP_COUNT" >> $GITHUB_OUTPUT
          echo "output_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
        id: check-change
        run: |
          OUTPUT_FILE="${{ steps.fetch.outputs.output_file }}"
          if [ -f "$OUTPUT_FILE" ]; then
            if git diff --quiet HEAD -- "$OUTPUT_FILE"; then
              echo "æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
              echo "has_change=false" >> $GITHUB_OUTPUT
            else
              echo "æ£€æµ‹åˆ°æ–‡ä»¶å†…å®¹å˜åŒ–ã€‚"
              echo "has_change=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "è¾“å‡ºæ–‡ä»¶ä¸å­˜åœ¨ã€‚"
            echo "has_change=false" >> $GITHUB_OUTPUT
          fi

      - name: æäº¤å¹¶æ¨é€æ›´æ–°
        if: steps.check-change.outputs.has_change == 'true'
        run: |
          OUTPUT_FILE="${{ steps.fetch.outputs.output_file }}"
          IP_COUNT="${{ steps.fetch.outputs.ip_count }}"
          git add "$OUTPUT_FILE"
          git commit -m "ğŸ“¡ æ›´æ–°å±±è¥¿ç»„æ’­é»‘åå• [$IP_COUNTä¸ªIP] - $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push