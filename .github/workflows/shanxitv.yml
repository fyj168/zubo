name: Update TV Source File - å±±è¥¿ç»„æ’­

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 09:00 = UTC 01:00
    - cron: '10 1 * * *'
    # åŒ—äº¬æ—¶é—´ 17:00 = UTC 09:00  
    - cron: '10 9 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-file:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
    - name: Prepare directory
      run: |
        mkdir -p tv
        echo "åˆ›å»º tv ç›®å½•..."
        
    - name: Download TV source file
      id: download
      run: |
        echo "å¼€å§‹ä¸‹è½½ç›´æ’­æºæ–‡ä»¶..."
        
        REMOTE_URL="https://my9.ltd/tv/pllive.txt"
        LOCAL_PATH="tv/pllive.txt"
        TEMP_FILE="pllive_temp.txt"
        
        echo "ç›®æ ‡URL: $REMOTE_URL"
        echo "ä¿å­˜è·¯å¾„: $LOCAL_PATH"
        
        # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶
        rm -f "$TEMP_FILE" "$LOCAL_PATH"
        
        # ä¸‹è½½æ–‡ä»¶
        echo ""
        echo "=== ä¸‹è½½ç›´æ’­æºæ–‡ä»¶ ==="
        curl -s -L \
          -o "$TEMP_FILE" \
          -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
          --max-time 60 \
          "$REMOTE_URL"
        
        if [ -f "$TEMP_FILE" ]; then
          FILE_SIZE=$(wc -c < "$TEMP_FILE" 2>/dev/null || echo 0)
          echo "åŸå§‹æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          
          if [ $FILE_SIZE -gt 1000 ]; then
            echo "åŸå§‹æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
            mv "$TEMP_FILE" "$LOCAL_PATH"
            echo "downloaded=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ åŸå§‹æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½ä¸‹è½½å¤±è´¥"
            rm -f "$TEMP_FILE"
            echo "downloaded=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥"
          echo "downloaded=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Filter Shanxi IPTV only
      id: filter
      if: steps.download.outputs.downloaded == 'true'
      run: |
        echo "å¼€å§‹è¿‡æ»¤å±±è¥¿ç»„æ’­åœ°å€..."
        
        SOURCE_FILE="tv/pllive.txt"
        SHANXI_FILE="tv/pllive_shanxi.txt"
        
        if [ ! -f "$SOURCE_FILE" ]; then
          echo "âŒ æºæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # ç»Ÿè®¡åŸå§‹æ–‡ä»¶ä¿¡æ¯
        ORIGINAL_SIZE=$(wc -c < "$SOURCE_FILE")
        ORIGINAL_LINES=$(wc -l < "$SOURCE_FILE" 2>/dev/null || echo 0)
        
        echo "åŸå§‹æ–‡ä»¶:"
        echo "- å¤§å°: $ORIGINAL_SIZE å­—èŠ‚"
        echo "- è¡Œæ•°: $ORIGINAL_LINES è¡Œ"
        
        # è¿‡æ»¤å±±è¥¿ç›¸å…³çš„å†…å®¹
        # åŒ¹é…å±±è¥¿ç»„æ’­IPåœ°å€ (239.253.x.x æˆ– rtp://239.253.x.x)
        # åŒæ—¶ä¿ç•™å±±è¥¿ç›¸å…³çš„é¢‘é“åç§°
        
        echo ""
        echo "å¼€å§‹è¿‡æ»¤..."
        
        # åˆ›å»ºå±±è¥¿ä¸“ç”¨æ–‡ä»¶ï¼Œæ·»åŠ æ–‡ä»¶å¤´
        echo "#EXTM3U" > "$SHANXI_FILE"
        echo "# å±±è¥¿ç»„æ’­åœ°å€è¿‡æ»¤ç‰ˆ" >> "$SHANXI_FILE"
        echo "# ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> "$SHANXI_FILE"
        echo "# æºæ–‡ä»¶: $SOURCE_FILE" >> "$SHANXI_FILE"
        echo "" >> "$SHANXI_FILE"
        
        # è¿‡æ»¤é€»è¾‘ï¼š
        # 1. åŒ…å«"å±±è¥¿"çš„é¢‘é“åç§°
        # 2. 239.253å¼€å¤´çš„ç»„æ’­IPåœ°å€
        # 3. rtp://239.253å¼€å¤´çš„ç»„æ’­åœ°å€
        
        SHANXI_COUNT=0
        while IFS= read -r line || [ -n "$line" ]; do
          # å¦‚æœè¡ŒåŒ…å«"å±±è¥¿"ï¼Œä¿ç•™æ•´ä¸ªæ¡ç›®ï¼ˆåŒ…æ‹¬åç»­çš„EXTINFå’ŒURLï¼‰
          if [[ "$line" =~ "å±±è¥¿" || "$line" =~ "sx" || "$line" =~ "SX" || "$line" =~ "shanxi" || "$line" =~ "Shanxi" ]]; then
            echo "$line" >> "$SHANXI_FILE"
            SHANXI_COUNT=$((SHANXI_COUNT + 1))
            continue
          fi
          
          # å¦‚æœè¡Œæ˜¯239.253å¼€å¤´çš„IPåœ°å€
          if [[ "$line" =~ ^239\.253\.[0-9]+\.[0-9]+:[0-9]+$ ]]; then
            echo "$line" >> "$SHANXI_FILE"
            SHANXI_COUNT=$((SHANXI_COUNT + 1))
            continue
          fi
          
          # å¦‚æœè¡Œæ˜¯rtp://239.253å¼€å¤´çš„åœ°å€
          if [[ "$line" =~ ^rtp://239\.253\.[0-9]+\.[0-9]+:[0-9]+(/[^ ]*)?$ ]]; then
            echo "$line" >> "$SHANXI_FILE"
            SHANXI_COUNT=$((SHANXI_COUNT + 1))
            continue
          fi
          
          # å¦‚æœè¡ŒåŒ…å«239.253ä¸”ä¸æ˜¯æ³¨é‡Š
          if [[ "$line" =~ 239\.253 ]] && [[ ! "$line" =~ ^# ]]; then
            echo "$line" >> "$SHANXI_FILE"
            SHANXI_COUNT=$((SHANXI_COUNT + 1))
          fi
        done < "$SOURCE_FILE"
        
        # ç»Ÿè®¡è¿‡æ»¤åçš„æ–‡ä»¶ä¿¡æ¯
        SHANXI_SIZE=$(wc -c < "$SHANXI_FILE")
        SHANXI_LINES=$(wc -l < "$SHANXI_FILE" 2>/dev/null || echo 0)
        
        echo ""
        echo "=== è¿‡æ»¤ç»“æœ ==="
        echo "å±±è¥¿ç»„æ’­æ–‡ä»¶: $SHANXI_FILE"
        echo "- å¤§å°: $SHANXI_SIZE å­—èŠ‚"
        echo "- è¡Œæ•°: $SHANXI_LINES è¡Œ"
        echo "- è¿‡æ»¤å‡ºçš„æ¡ç›®æ•°: $SHANXI_COUNT ä¸ª"
        
        # è®¡ç®—å‹ç¼©ç‡
        if [ $ORIGINAL_SIZE -gt 0 ]; then
          RATIO=$((SHANXI_SIZE * 100 / ORIGINAL_SIZE))
          echo "- å‹ç¼©ç‡: çº¦ $RATIO% (åŸæ–‡ä»¶çš„ $RATIO%)"
        fi
        
        # æ˜¾ç¤ºå‰10è¡Œå†…å®¹é¢„è§ˆ
        echo ""
        echo "=== å†…å®¹é¢„è§ˆ (å‰15è¡Œ) ==="
        head -15 "$SHANXI_FILE"
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å±±è¥¿å†…å®¹ï¼Œæ·»åŠ æç¤º
        if [ $SHANXI_COUNT -eq 0 ]; then
          echo ""
          echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°å±±è¥¿ç›¸å…³çš„å†…å®¹"
          echo "# æœªæ‰¾åˆ°å±±è¥¿ç»„æ’­åœ°å€ï¼Œè¯·æ£€æŸ¥æºæ–‡ä»¶" >> "$SHANXI_FILE"
          echo "# åŸå§‹æ–‡ä»¶å¯èƒ½ä¸åŒ…å«å±±è¥¿IPæˆ–æ ¼å¼å·²å˜åŒ–" >> "$SHANXI_FILE"
          
          # æ˜¾ç¤ºä¸€äº›å¯èƒ½çš„å±±è¥¿IPç¤ºä¾‹
          echo "" >> "$SHANXI_FILE"
          echo "# å±±è¥¿ç»„æ’­ç¤ºä¾‹:" >> "$SHANXI_FILE"
          echo "# rtp://239.253.0.1:5140" >> "$SHANXI_FILE"
          echo "# rtp://239.253.1.1:1234" >> "$SHANXI_FILE"
        fi
        
        echo "filtered=true" >> $GITHUB_OUTPUT
        echo "shanxi_count=$SHANXI_COUNT" >> $GITHUB_OUTPUT
        
    - name: Check if file changed
      id: check-change
      if: steps.filter.outputs.filtered == 'true'
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜åŒ–..."
        
        FILE_PATH="tv/pllive_shanxi.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ å±±è¥¿ç»„æ’­æ–‡ä»¶ä¸å­˜åœ¨"
          echo "has_change=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # ä½¿ç”¨ç®€å•çš„å¤§å°æ¯”è¾ƒ
        CURRENT_SIZE=$(wc -c < "$FILE_PATH" 2>/dev/null || echo 0)
        echo "å½“å‰æ–‡ä»¶å¤§å°: $CURRENT_SIZE å­—èŠ‚"
        
        if git ls-files "$FILE_PATH" >/dev/null 2>&1; then
          # è·å–Gitä¸­çš„æ–‡ä»¶å¤§å°
          GIT_SIZE=$(git cat-file -s :"$FILE_PATH" 2>/dev/null || echo 0)
          echo "Gitä¸­æ–‡ä»¶å¤§å°: $GIT_SIZE å­—èŠ‚"
          
          if [ $CURRENT_SIZE -eq $GIT_SIZE ] && [ $CURRENT_SIZE -gt 100 ]; then
            # å¦‚æœå¤§å°ç›¸åŒä¸”æ–‡ä»¶è¾ƒå¤§ï¼Œè¿›ä¸€æ­¥æ£€æŸ¥å†…å®¹
            CURRENT_HASH=$(md5sum "$FILE_PATH" | cut -d' ' -f1)
            GIT_HASH=$(git hash-object "$FILE_PATH")
            
            if [ "$CURRENT_HASH" = "$GIT_HASH" ]; then
              echo "æ–‡ä»¶æ— å˜åŒ–"
              echo "has_change=false" >> $GITHUB_OUTPUT
            else
              echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ– (å“ˆå¸Œä¸åŒ)"
              echo "has_change=true" >> $GITHUB_OUTPUT
            fi
          elif [ $CURRENT_SIZE -ne $GIT_SIZE ]; then
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ– (å¤§å°ä¸åŒ)"
            echo "has_change=true" >> $GITHUB_OUTPUT
          else
            echo "æ–‡ä»¶å¯èƒ½ä¸ºç©ºæˆ–æ— æ•ˆ"
            echo "has_change=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "æ–‡ä»¶æœªè¢«Gitè·Ÿè¸ªï¼Œæ˜¯æ–°æ–‡ä»¶"
          echo "has_change=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-change.outputs.has_change == 'true'
      run: |
        echo "å‡†å¤‡æäº¤å±±è¥¿ç»„æ’­æ–‡ä»¶..."
        
        SOURCE_FILE="tv/pllive.txt"
        SHANXI_FILE="tv/pllive_shanxi.txt"
        
        if [ ! -f "$SHANXI_FILE" ]; then
          echo "âŒ å±±è¥¿ç»„æ’­æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æäº¤"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < "$SHANXI_FILE")
        FILE_LINES=$(wc -l < "$SHANXI_FILE" 2>/dev/null || echo 0)
        FILE_MD5=$(md5sum "$SHANXI_FILE" | cut -d' ' -f1 2>/dev/null || echo "unknown")
        SHANXI_COUNT="${{ steps.filter.outputs.shanxi_count }}"
        
        echo "=== æäº¤ä¿¡æ¯ ==="
        echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
        echo "æ–‡ä»¶è¡Œæ•°: $FILE_LINES è¡Œ"
        echo "å±±è¥¿æ¡ç›®æ•°: $SHANXI_COUNT ä¸ª"
        echo "æ–‡ä»¶MD5: $FILE_MD5"
        
        git add "$SHANXI_FILE"
        
        # æäº¤ä¿¡æ¯
        COMMIT_MSG="ğŸ“¡ æ›´æ–°å±±è¥¿ç»„æ’­åœ°å€ - $(date '+%Y-%m-%d %H:%M UTC')"
        COMMIT_MSG="$COMMIT_MSG | æ¡ç›®: ${SHANXI_COUNT}ä¸ª"
        COMMIT_MSG="$COMMIT_MSG | å¤§å°: ${FILE_SIZE}å­—èŠ‚"
        
        if [ $FILE_LINES -gt 0 ]; then
          COMMIT_MSG="$COMMIT_MSG | è¡Œæ•°: ${FILE_LINES}è¡Œ"
        fi
        
        git commit -m "$COMMIT_MSG"
        
        echo "æ¨é€åˆ°GitHub..."
        git push
        
        echo "âœ… æäº¤å¹¶æ¨é€å®Œæˆ"
        
    - name: Show detailed final status
      run: |
        echo "=========================================="
        echo "          å±±è¥¿ç»„æ’­æŠ“å–æŠ¥å‘Š"
        echo "=========================================="
        
        echo "æ‰§è¡Œå®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "å¯¹åº”åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        
        echo ""
        echo "ğŸ“ æ–‡ä»¶åˆ—è¡¨:"
        ls -lh tv/*.txt 2>/dev/null || echo "tvç›®å½•ä¸‹æ— æ–‡ä»¶"
        
        echo ""
        if [ -f "tv/pllive_shanxi.txt" ]; then
          echo "âœ… å±±è¥¿ç»„æ’­æ–‡ä»¶å·²ç”Ÿæˆ"
          echo ""
          echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
          ls -lh "tv/pllive_shanxi.txt"
          
          echo ""
          echo "ğŸ” å†…å®¹åˆ†æ:"
          FILE_SIZE=$(wc -c < "tv/pllive_shanxi.txt")
          FILE_LINES=$(wc -l < "tv/pllive_shanxi.txt" 2>/dev/null || echo 0)
          
          echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          echo "æ–‡ä»¶è¡Œæ•°: $FILE_LINES è¡Œ"
          
          if [ $FILE_SIZE -gt 100 ]; then
            echo ""
            echo "ğŸ“º é¢‘é“é¢„è§ˆ:"
            echo "----------------------------------------"
            # æ˜¾ç¤ºéæ³¨é‡Šè¡Œçš„å‰10è¡Œ
            grep -v "^#" "tv/pllive_shanxi.txt" | head -10
            echo "----------------------------------------"
            
            # ç»Ÿè®¡ç»„æ’­åœ°å€æ•°é‡
            echo ""
            echo "ğŸ”¢ åœ°å€ç»Ÿè®¡:"
            echo "rtpç»„æ’­åœ°å€: $(grep -c "rtp://" "tv/pllive_shanxi.txt" 2>/dev/null || echo "0")"
            echo "239.253åœ°å€: $(grep -c "239\.253" "tv/pllive_shanxi.txt" 2>/dev/null || echo "0")"
            echo "åŒ…å«'å±±è¥¿'çš„é¢‘é“: $(grep -c "å±±è¥¿" "tv/pllive_shanxi.txt" 2>/dev/null || echo "0")"
          else
            echo "âš ï¸ æ–‡ä»¶å†…å®¹è¿‡å°‘ï¼Œå¯èƒ½æœªæ‰¾åˆ°å±±è¥¿ç»„æ’­"
            echo "å®Œæ•´å†…å®¹:"
            echo "----------------------------------------"
            cat "tv/pllive_shanxi.txt"
            echo "----------------------------------------"
          fi
        else
          echo "âŒ å±±è¥¿ç»„æ’­æ–‡ä»¶æœªç”Ÿæˆ"
        fi
        
        echo ""
        echo "ğŸ”„ åŸå§‹æ–‡ä»¶çŠ¶æ€:"
        if [ -f "tv/pllive.txt" ]; then
          ORIG_SIZE=$(wc -c < "tv/pllive.txt")
          echo "- åŸå§‹æ–‡ä»¶å¤§å°: $ORIG_SIZE å­—èŠ‚"
        else
          echo "- åŸå§‹æ–‡ä»¶: ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "â° ä¸‹æ¬¡è‡ªåŠ¨æ‰§è¡Œ: æ¯å¤© UTC 01:10 å’Œ 09:10 (åŒ—äº¬æ—¶é—´ 09:10 å’Œ 17:10)"