name: Update Shanxi TV Source File

on:
  schedule:
    # 北京时间 09:00 = UTC 01:00
    - cron: '10 1 * * *'
    # 北京时间 17:00 = UTC 09:00  
    - cron: '10 9 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-file:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
    - name: Prepare directory
      run: |
        mkdir -p tv
        echo "创建 tv 目录..."
        
    - name: Download and filter TV source file
      id: download
      run: |
        echo "开始下载并过滤山西组播源..."
        
        REMOTE_URL="https://my9.ltd/tv/pllive.txt"
        LOCAL_PATH="tv/shanxi-iptv.txt"
        TEMP_FILE="pllive_temp.txt"
        FILTERED_FILE="shanxi_filtered.txt"
        
        echo "目标URL: $REMOTE_URL"
        echo "保存路径: $LOCAL_PATH"
        
        # 清空临时文件
        rm -f "$TEMP_FILE" "$FILTERED_FILE" "$LOCAL_PATH"
        
        # 下载源文件
        echo ""
        echo "=== 下载源文件 ==="
        curl -s -L \
          -o "$TEMP_FILE" \
          -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
          --max-time 60 \
          "$REMOTE_URL"
        
        if [ ! -f "$TEMP_FILE" ] || [ ! -s "$TEMP_FILE" ]; then
          echo "❌ 下载失败"
          # 创建空文件占位
          echo "# 山西组播源文件 - $(date '+%Y-%m-%d %H:%M:%S')" > "$LOCAL_PATH"
          echo "# 原地址: $REMOTE_URL" >> "$LOCAL_PATH"
          echo "# 只包含山西联通和山西电信组播" >> "$LOCAL_PATH"
          echo "downloaded=true" >> $GITHUB_OUTPUT
          echo "method=failed_download" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        FILE_SIZE=$(wc -c < "$TEMP_FILE")
        echo "源文件大小: $FILE_SIZE 字节"
        
        # 过滤山西组播源
        echo ""
        echo "=== 过滤山西组播源 ==="
        
        # 创建文件头部
        echo "#EXTM3U x-tvg-url=\"\"" > "$FILTERED_FILE"
        echo "#山西组播源 - 更新于 $(date '+%Y-%m-%d %H:%M:%S')" >> "$FILTERED_FILE"
        echo "#来源: $REMOTE_URL" >> "$FILTERED_FILE"
        echo "#只包含山西联通和山西电信组播" >> "$FILTERED_FILE"
        echo "" >> "$FILTERED_FILE"
        
        # 过滤逻辑
        SHANXI_COUNT=0
        
        # 方法1：直接搜索包含"山西"的行
        echo "搜索包含'山西'的频道..."
        while IFS= read -r line || [ -n "$line" ]; do
          if [[ "$line" =~ .*山西.* ]] || 
             [[ "$line" =~ .*SX.* ]] || 
             [[ "$line" =~ .*shanxi.* ]] || 
             [[ "$line" =~ .*Shanxi.* ]]; then
            # 检查是否是组播地址
            if [[ "$line" =~ rtp://.* ]] || 
               [[ "$line" =~ udp://.* ]] || 
               [[ "$line" =~ 239\..* ]] || 
               [[ "$line" =~ 224\..* ]]; then
              echo "$line" >> "$FILTERED_FILE"
              ((SHANXI_COUNT++))
            fi
          fi
        done < "$TEMP_FILE"
        
        # 方法2：搜索特定组播段
        if [ $SHANXI_COUNT -lt 5 ]; then
          echo "搜索特定组播IP段..."
          # 山西常见的组播IP段
          SHANXI_MULTICAST_PATTERNS=(
            "239.69.*"
            "239.254.*"
            "239.253.*"
            "239.1.*"
            "239.2.*"
          )
          
          for pattern in "${SHANXI_MULTICAST_PATTERNS[@]}"; do
            echo "搜索模式: $pattern"
            grep -E "$pattern" "$TEMP_FILE" | while IFS= read -r line; do
              # 检查是否包含频道信息（不只是IP地址）
              if [[ "$line" =~ ,.* ]] || [[ "$line" =~ #.* ]]; then
                echo "$line" >> "$FILTERED_FILE"
                ((SHANXI_COUNT++))
              fi
            done
          done
        fi
        
        # 方法3：按运营商过滤
        if [ $SHANXI_COUNT -lt 10 ]; then
          echo "按运营商关键字过滤..."
          OPERATOR_KEYWORDS=(
            "山西联通"
            "山西电信"
            "SXLT"
            "SXDX"
            "联通山西"
            "电信山西"
            "太原联通"
            "太原电信"
            "晋中"
            "大同"
            "运城"
            "临汾"
            "长治"
            "晋城"
            "朔州"
            "忻州"
            "吕梁"
            "阳泉"
          )
          
          for keyword in "${OPERATOR_KEYWORDS[@]}"; do
            echo "搜索关键字: $keyword"
            grep -i "$keyword" "$TEMP_FILE" | while IFS= read -r line; do
              # 检查是否是组播地址
              if [[ "$line" =~ rtp://.* ]] || 
                 [[ "$line" =~ udp://.* ]] || 
                 [[ "$line" =~ 239\..* ]] || 
                 [[ "$line" =~ 224\..* ]]; then
                if ! grep -q "$line" "$FILTERED_FILE"; then
                  echo "$line" >> "$FILTERED_FILE"
                  ((SHANXI_COUNT++))
                fi
              fi
            done
          done
        fi
        
        # 如果找到山西源，处理文件
        if [ $SHANXI_COUNT -gt 0 ]; then
          echo "✅ 找到 $SHANXI_COUNT 个山西组播源"
          
          # 去重并排序
          echo ""
          echo "=== 处理最终文件 ==="
          
          # 提取所有组播行，去重，按频道名称排序
          grep -v "^#" "$FILTERED_FILE" | sort -u > "$LOCAL_PATH.tmp"
          
          # 重新构建文件
          echo "#EXTM3U x-tvg-url=\"\"" > "$LOCAL_PATH"
          echo "#山西组播源 - 更新于 $(date '+%Y-%m-%d %H:%M:%S')" >> "$LOCAL_PATH"
          echo "#来源: $REMOTE_URL" >> "$LOCAL_PATH"
          echo "#频道数量: $SHANXI_COUNT" >> "$LOCAL_PATH"
          echo "" >> "$LOCAL_PATH"
          
          # 按运营商分组
          echo "#山西联通组播" >> "$LOCAL_PATH"
          grep -i "联通\|LT" "$LOCAL_PATH.tmp" | sort >> "$LOCAL_PATH"
          echo "" >> "$LOCAL_PATH"
          
          echo "#山西电信组播" >> "$LOCAL_PATH"
          grep -i "电信\|DX" "$LOCAL_PATH.tmp" | grep -v "联通" | sort >> "$LOCAL_PATH"
          echo "" >> "$LOCAL_PATH"
          
          echo "#其他山西组播" >> "$LOCAL_PATH"
          grep -v -i "联通\|电信\|LT\|DX" "$LOCAL_PATH.tmp" | sort >> "$LOCAL_PATH"
          
          rm -f "$LOCAL_PATH.tmp"
          
          # 更新实际数量
          ACTUAL_COUNT=$(grep -c "rtp://\|udp://" "$LOCAL_PATH" 2>/dev/null || echo 0)
          sed -i "s/#频道数量: $SHANXI_COUNT/#频道数量: $ACTUAL_COUNT/" "$LOCAL_PATH"
          
          echo "✅ 过滤完成，共 $ACTUAL_COUNT 个山西组播频道"
          echo "downloaded=true" >> $GITHUB_OUTPUT
          echo "method=filtered_shanxi" >> $GITHUB_OUTPUT
        else
          echo "⚠️ 未找到山西组播源"
          
          # 创建说明文件
          echo "#山西组播源 - $(date '+%Y-%m-%d %H:%M:%S')" > "$LOCAL_PATH"
          echo "#未在源文件中找到山西联通或山西电信组播" >> "$LOCAL_PATH"
          echo "#原文件大小: $FILE_SIZE 字节" >> "$LOCAL_PATH"
          echo "#如需山西组播源，请提供更准确的源地址或关键字" >> "$LOCAL_PATH"
          echo "" >> "$LOCAL_PATH"
          echo "#常见山西组播格式示例:" >> "$LOCAL_PATH"
          echo "#山西联通,rtp://239.69.1.1:8000" >> "$LOCAL_PATH"
          echo "#山西电信,rtp://239.254.1.1:8000" >> "$LOCAL_PATH"
          
          echo "downloaded=true" >> $GITHUB_OUTPUT
          echo "method=no_shanxi_found" >> $GITHUB_OUTPUT
        fi
        
        # 清理临时文件
        rm -f "$TEMP_FILE" "$FILTERED_FILE"
        
    - name: Check if file changed
      id: check-change
      if: steps.download.outputs.downloaded == 'true'
      run: |
        echo "检查文件变化..."
        
        FILE_PATH="tv/shanxi-iptv.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "❌ 文件不存在"
          echo "has_change=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # 获取当前文件信息
        CURRENT_SIZE=$(wc -c < "$FILE_PATH" 2>/dev/null || echo 0)
        CURRENT_LINES=$(wc -l < "$FILE_PATH" 2>/dev/null || echo 0)
        echo "当前文件大小: $CURRENT_SIZE 字节"
        echo "当前文件行数: $CURRENT_LINES 行"
        
        # 统计频道数量
        CHANNEL_COUNT=$(grep -c "rtp://\|udp://" "$FILE_PATH" 2>/dev/null || echo 0)
        echo "组播频道数量: $CHANNEL_COUNT"
        
        if git ls-files "$FILE_PATH" >/dev/null 2>&1; then
          # 文件已被Git跟踪，比较变化
          CURRENT_HASH=$(md5sum "$FILE_PATH" | cut -d' ' -f1)
          GIT_HASH=$(git hash-object "$FILE_PATH")
          
          if [ "$CURRENT_HASH" = "$GIT_HASH" ]; then
            echo "文件无变化"
            echo "has_change=false" >> $GITHUB_OUTPUT
          else
            echo "检测到文件变化"
            echo "has_change=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "文件未被Git跟踪，是新文件"
          echo "has_change=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-change.outputs.has_change == 'true'
      run: |
        echo "准备提交山西组播源文件..."
        
        FILE_PATH="tv/shanxi-iptv.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "❌ 文件不存在，无法提交"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < "$FILE_PATH")
        FILE_LINES=$(wc -l < "$FILE_PATH" 2>/dev/null || echo 0)
        CHANNEL_COUNT=$(grep -c "rtp://\|udp://" "$FILE_PATH" 2>/dev/null || echo 0)
        FILE_MD5=$(md5sum "$FILE_PATH" | cut -d' ' -f1 2>/dev/null || echo "unknown")
        METHOD="${{ steps.download.outputs.method }}"
        
        echo "=== 提交信息 ==="
        echo "文件大小: $FILE_SIZE 字节"
        echo "文件行数: $FILE_LINES 行"
        echo "频道数量: $CHANNEL_COUNT 个"
        echo "文件MD5: $FILE_MD5"
        echo "下载方法: $METHOD"
        
        git add "$FILE_PATH"
        
        # 提交信息
        COMMIT_MSG="📡 更新山西组播源 - $(date '+%Y-%m-%d %H:%M UTC')"
        
        if [ $CHANNEL_COUNT -gt 0 ]; then
          COMMIT_MSG="$COMMIT_MSG | 频道: ${CHANNEL_COUNT}个"
        fi
        
        COMMIT_MSG="$COMMIT_MSG | 大小: ${FILE_SIZE}字节"
        COMMIT_MSG="$COMMIT_MSG | 方法: ${METHOD}"
        
        git commit -m "$COMMIT_MSG"
        
        echo "推送到GitHub..."
        git push
        
        echo "✅ 提交并推送完成"
        
    - name: Show detailed final status
      run: |
        echo "=========================================="
        echo "          山西组播源更新报告"
        echo "=========================================="
        
        echo "执行完成时间: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "对应北京时间: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        
        echo ""
        echo "📁 输出文件: tv/shanxi-iptv.txt"
        
        if [ -f "tv/shanxi-iptv.txt" ]; then
          echo "✅ 文件存在"
          echo "文件信息:"
          ls -lh "tv/shanxi-iptv.txt"
          
          echo ""
          echo "📊 内容分析:"
          FILE_SIZE=$(wc -c < "tv/shanxi-iptv.txt")
          echo "文件大小: $FILE_SIZE 字节"
          echo "总行数: $(wc -l < "tv/shanxi-iptv.txt" 2>/dev/null || echo "N/A")"
          
          # 统计不同类型
          echo ""
          echo "🔢 频道统计:"
          echo "总组播频道数: $(grep -c "rtp://\|udp://" "tv/shanxi-iptv.txt" 2>/dev/null || echo "0")"
          echo "山西联通频道: $(grep -c -i "联通\|LT" "tv/shanxi-iptv.txt" 2>/dev/null || echo "0")"
          echo "山西电信频道: $(grep -c -i "电信\|DX" "tv/shanxi-iptv.txt" 2>/dev/null || echo "0")"
          echo "RTP协议: $(grep -c "rtp://" "tv/shanxi-iptv.txt" 2>/dev/null || echo "0")"
          echo "UDP协议: $(grep -c "udp://" "tv/shanxi-iptv.txt" 2>/dev/null || echo "0")"
          
          echo ""
          echo "📺 内容预览 (前15行):"
          echo "----------------------------------------"
          head -15 "tv/shanxi-iptv.txt"
          echo "----------------------------------------"
          
          # 显示一些频道示例
          echo ""
          echo "📡 频道示例:"
          grep -E "rtp://|udp://" "tv/shanxi-iptv.txt" | head -5
        else
          echo "❌ 文件不存在"
        fi
        
        echo ""
        echo "⏰ 下次自动执行: 每天 UTC 01:10 和 09:10 (北京时间 09:10 和 17:10)"
        echo ""
        echo "💡 提示: 此工作流只抓取山西联通和山西电信的组播源"
        echo "       如需其他地区或协议，请修改过滤规则"