name: Update Shanxi TV Sources

on:
  schedule:
    # 北京时间 09:00 = UTC 01:00
    - cron: '10 1 * * *'
    # 北京时间 17:00 = UTC 09:00  
    - cron: '10 9 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-file:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
    - name: Prepare directory
      run: |
        mkdir -p tv
        echo "创建 tv 目录..."
        
    - name: Test URL with verbose output
      run: |
        echo "=== 测试URL访问 ==="
        REMOTE_URL="https://my9.ltd/tv/pllive.txt"
        
        echo "1. 使用curl测试HTTP头:"
        curl -I -L \
          -H "User-Agent: Mozilla/5.0" \
          --max-time 30 \
          "$REMOTE_URL" 2>&1 | head -20 || echo "curl失败"
          
        echo ""
        echo "2. 下载前10K测试内容:"
        curl -s -L \
          -H "User-Agent: curl/8.8.0" \
          --max-time 30 \
          --range 0-10240 \
          "$REMOTE_URL" | head -c 500 && echo "..."
          
    - name: Download and filter Shanxi sources
      id: download
      run: |
        echo "开始下载并过滤山西联通/电信组播源..."
        
        REMOTE_URL="https://my9.ltd/tv/pllive.txt"
        LOCAL_PATH="tv/shanxi_iptv.txt"
        TEMP_FILE="pllive_temp.txt"
        FILTERED_FILE="shanxi_filtered.txt"
        
        echo "目标URL: $REMOTE_URL"
        echo "保存路径: $LOCAL_PATH"
        
        # 清空临时文件
        rm -f "$TEMP_FILE" "$FILTERED_FILE" "$LOCAL_PATH"
        
        # 下载完整文件
        echo ""
        echo "=== 下载原始文件 ==="
        curl -s -L \
          -o "$TEMP_FILE" \
          -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
          --max-time 60 \
          "$REMOTE_URL"
        
        if [ -f "$TEMP_FILE" ] && [ -s "$TEMP_FILE" ]; then
          FILE_SIZE=$(wc -c < "$TEMP_FILE")
          echo "原始文件大小: $FILE_SIZE 字节"
          echo "原始文件行数: $(wc -l < "$TEMP_FILE")"
          
          # 过滤山西联通和山西电信组播源
          echo ""
          echo "=== 过滤山西联通/电信组播源 ==="
          
          # 创建文件头
          echo "# Shanxi IPTV Group Channels" > "$FILTERED_FILE"
          echo "# 山西联通/电信组播源" >> "$FILTERED_FILE"
          echo "# 更新时间: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> "$FILTERED_FILE"
          echo "# 数据来源: $REMOTE_URL" >> "$FILTERED_FILE"
          echo "" >> "$FILTERED_FILE"
          
          # 1. 首先抓取明显的山西相关频道（包含频道名）
          echo "# 山西联通" >> "$FILTERED_FILE"
          grep -E -i "山西.*联通|联通.*山西|shanxi.*unicom" "$TEMP_FILE" >> "$FILTERED_FILE" 2>/dev/null || true
          
          echo "" >> "$FILTERED_FILE"
          echo "# 山西电信" >> "$FILTERED_FILE"
          grep -E -i "山西.*电信|电信.*山西|shanxi.*telecom" "$TEMP_FILE" >> "$FILTERED_FILE" 2>/dev/null || true
          
          echo "" >> "$FILTERED_FILE"
          echo "# 山西移动" >> "$FILTERED_FILE"
          grep -E -i "山西.*移动|移动.*山西|shanxi.*mobile" "$TEMP_FILE" >> "$FILTERED_FILE" 2>/dev/null || true
          
          echo "" >> "$FILTERED_FILE"
          echo "# 山西组播地址 (rtp/udp)" >> "$FILTERED_FILE"
          
          # 2. 抓取组播地址 (rtp://, udp://)
          # 先抓取可能包含山西的组播行
          grep -E -B1 -A0 "rtp://.*山西|udp://.*山西|rtp://.*239\..*山西|udp://.*239\..*山西" "$TEMP_FILE" >> "$FILTERED_FILE" 2>/dev/null || true
          
          # 3. 抓取所有山西相关的行（宽泛匹配）
          echo "" >> "$FILTERED_FILE"
          echo "# 其他山西相关频道" >> "$FILTERED_FILE"
          grep -E -i "山西|sx-|shanxi" "$TEMP_FILE" >> "$FILTERED_FILE" 2>/dev/null || true
          
          # 4. 专门抓取组播地址段 (239.开头的IP)
          echo "" >> "$FILTERED_FILE"
          echo "# 组播地址段 (可能需要根据山西网络配置)" >> "$FILTERED_FILE"
          grep -E -B1 "rtp://239\.|udp://239\.|rtp://232\.|udp://232\." "$TEMP_FILE" | head -50 >> "$FILTERED_FILE" 2>/dev/null || true
          
          # 去重和清理
          echo ""
          echo "=== 清理和去重 ==="
          sort -u "$FILTERED_FILE" -o "$FILTERED_FILE.tmp"
          mv "$FILTERED_FILE.tmp" "$LOCAL_PATH"
          
          # 移除完全空的行
          sed -i '/^$/d' "$LOCAL_PATH"
          
          # 统计结果
          FILTERED_SIZE=$(wc -c < "$LOCAL_PATH")
          FILTERED_LINES=$(wc -l < "$LOCAL_PATH")
          
          echo "过滤后文件大小: $FILTERED_SIZE 字节"
          echo "过滤后行数: $FILTERED_LINES 行"
          
          if [ $FILTERED_LINES -gt 5 ]; then
            echo "✅ 成功过滤出山西相关频道"
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "filtered_lines=$FILTERED_LINES" >> $GITHUB_OUTPUT
            
            # 显示过滤出的频道类型统计
            echo ""
            echo "=== 频道类型统计 ==="
            echo "山西联通: $(grep -c -i "联通" "$LOCAL_PATH") 个"
            echo "山西电信: $(grep -c -i "电信" "$LOCAL_PATH") 个"
            echo "山西移动: $(grep -c -i "移动" "$LOCAL_PATH") 个"
            echo "组播地址: $(grep -c -E "rtp://|udp://" "$LOCAL_PATH") 个"
            echo "总山西相关: $(grep -c -i "山西" "$LOCAL_PATH") 个"
            
          else
            echo "⚠️ 过滤出的内容太少，尝试备用方法"
            
            # 备用方法：抓取所有组播源
            echo ""
            echo "=== 备用方法：抓取所有组播源 ==="
            echo "# 全部组播源 (备用)" > "$LOCAL_PATH"
            echo "# 更新时间: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> "$LOCAL_PATH"
            echo "" >> "$LOCAL_PATH"
            
            # 抓取所有组播地址
            grep -E -B1 "rtp://|udp://" "$TEMP_FILE" | head -100 >> "$LOCAL_PATH" 2>/dev/null || true
            
            ALTERNATIVE_LINES=$(wc -l < "$LOCAL_PATH")
            echo "备用方法行数: $ALTERNATIVE_LINES 行"
            
            if [ $ALTERNATIVE_LINES -gt 10 ]; then
              echo "✅ 备用方法成功"
              echo "downloaded=true" >> $GITHUB_OUTPUT
              echo "filtered_lines=$ALTERNATIVE_LINES" >> $GITHUB_OUTPUT
              echo "method=alternative_all_multicast" >> $GITHUB_OUTPUT
            else
              echo "❌ 所有方法都失败"
              echo "downloaded=false" >> $GITHUB_OUTPUT
            fi
          fi
          
          # 清理临时文件
          rm -f "$TEMP_FILE" "$FILTERED_FILE"
          
        else
          echo "❌ 文件下载失败"
          echo "downloaded=false" >> $GITHUB_OUTPUT
          
          # 创建占位文件
          echo "# 山西IPTV组播源" > "$LOCAL_PATH"
          echo "# 文件下载失败 - $(date '+%Y-%m-%d %H:%M:%S UTC')" >> "$LOCAL_PATH"
          echo "# 原始URL: $REMOTE_URL" >> "$LOCAL_PATH"
        fi
        
    - name: Check if file changed
      id: check-change
      if: steps.download.outputs.downloaded == 'true'
      run: |
        echo "检查文件变化..."
        
        FILE_PATH="tv/shanxi_iptv.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "❌ 文件不存在"
          echo "has_change=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # 使用简单的大小比较
        CURRENT_SIZE=$(wc -c < "$FILE_PATH" 2>/dev/null || echo 0)
        echo "当前文件大小: $CURRENT_SIZE 字节"
        echo "当前文件行数: $(wc -l < "$FILE_PATH") 行"
        
        if git ls-files "$FILE_PATH" >/dev/null 2>&1; then
          # 获取Git中的文件大小
          GIT_SIZE=$(git cat-file -s :"$FILE_PATH" 2>/dev/null || echo 0)
          echo "Git中文件大小: $GIT_SIZE 字节"
          
          if [ $CURRENT_SIZE -eq $GIT_SIZE ] && [ $CURRENT_SIZE -gt 10 ]; then
            # 如果大小相同且文件合理，进一步检查内容
            CURRENT_HASH=$(md5sum "$FILE_PATH" | cut -d' ' -f1)
            GIT_HASH=$(git hash-object "$FILE_PATH")
            
            if [ "$CURRENT_HASH" = "$GIT_HASH" ]; then
              echo "文件无变化"
              echo "has_change=false" >> $GITHUB_OUTPUT
            else
              echo "检测到文件变化 (哈希不同)"
              echo "has_change=true" >> $GITHUB_OUTPUT
            fi
          elif [ $CURRENT_SIZE -ne $GIT_SIZE ]; then
            echo "检测到文件变化 (大小不同)"
            echo "has_change=true" >> $GITHUB_OUTPUT
          else
            echo "文件可能为空或无效"
            echo "has_change=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "文件未被Git跟踪，是新文件"
          echo "has_change=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-change.outputs.has_change == 'true'
      run: |
        echo "准备提交山西IPTV文件..."
        
        FILE_PATH="tv/shanxi_iptv.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "❌ 文件不存在，无法提交"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < "$FILE_PATH")
        FILE_LINES=$(wc -l < "$FILE_PATH" 2>/dev/null || echo 0)
        FILE_MD5=$(md5sum "$FILE_PATH" | cut -d' ' -f1 2>/dev/null || echo "unknown")
        
        # 统计各类频道数量
        UNICOM_COUNT=$(grep -c -i "联通" "$FILE_PATH" 2>/dev/null || echo 0)
        TELECOM_COUNT=$(grep -c -i "电信" "$FILE_PATH" 2>/dev/null || echo 0)
        MOBILE_COUNT=$(grep -c -i "移动" "$FILE_PATH" 2>/dev/null || echo 0)
        MULTICAST_COUNT=$(grep -c -E "rtp://|udp://" "$FILE_PATH" 2>/dev/null || echo 0)
        SHANXI_COUNT=$(grep -c -i "山西" "$FILE_PATH" 2>/dev/null || echo 0)
        
        echo "=== 提交信息 ==="
        echo "文件大小: $FILE_SIZE 字节"
        echo "文件行数: $FILE_LINES 行"
        echo "山西联通: $UNICOM_COUNT 个"
        echo "山西电信: $TELECOM_COUNT 个"
        echo "山西移动: $MOBILE_COUNT 个"
        echo "组播地址: $MULTICAST_COUNT 个"
        echo "山西相关: $SHANXI_COUNT 个"
        
        git add "$FILE_PATH"
        
        # 提交信息
        COMMIT_MSG="📡 更新山西IPTV组播源 - $(date '+%Y-%m-%d %H:%M UTC')"
        COMMIT_MSG="$COMMIT_MSG | 大小: ${FILE_SIZE}字节"
        
        if [ $FILE_LINES -gt 0 ]; then
          COMMIT_MSG="$COMMIT_MSG | 行数: ${FILE_LINES}行"
        fi
        
        if [ $SHANXI_COUNT -gt 0 ]; then
          COMMIT_MSG="$COMMIT_MSG | 山西频道: ${SHANXI_COUNT}个"
        fi
        
        if [ $MULTICAST_COUNT -gt 0 ]; then
          COMMIT_MSG="$COMMIT_MSG | 组播: ${MULTICAST_COUNT}个"
        fi
        
        git commit -m "$COMMIT_MSG"
        
        echo "推送到GitHub..."
        git push
        
        echo "✅ 提交并推送完成"
        
    - name: Show detailed final status
      run: |
        echo "=========================================="
        echo "          山西IPTV源更新报告"
        echo "=========================================="
        
        echo "执行完成时间: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "对应北京时间: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        
        echo ""
        if [ -f "tv/shanxi_iptv.txt" ]; then
          echo "✅ 山西IPTV文件存在"
          echo "文件信息:"
          ls -lh "tv/shanxi_iptv.txt"
          
          echo ""
          echo "📊 内容分析:"
          FILE_SIZE=$(wc -c < "tv/shanxi_iptv.txt")
          FILE_LINES=$(wc -l < "tv/shanxi_iptv.txt")
          echo "文件大小: $FILE_SIZE 字节"
          echo "文件行数: $FILE_LINES 行"
          
          echo ""
          echo "🔢 频道统计:"
          echo "山西联通: $(grep -c -i "联通" "tv/shanxi_iptv.txt") 个"
          echo "山西电信: $(grep -c -i "电信" "tv/shanxi_iptv.txt") 个"
          echo "山西移动: $(grep -c -i "移动" "tv/shanxi_iptv.txt") 个"
          echo "组播地址: $(grep -c -E "rtp://|udp://" "tv/shanxi_iptv.txt") 个"
          echo "总山西相关: $(grep -c -i "山西" "tv/shanxi_iptv.txt") 个"
          
          echo ""
          echo "📺 内容预览 (前15行):"
          echo "----------------------------------------"
          head -15 "tv/shanxi_iptv.txt"
          echo "----------------------------------------"
          
          echo ""
          echo "📡 组播地址示例:"
          grep -E "rtp://|udp://" "tv/shanxi_iptv.txt" | head -5 || echo "未找到组播地址"
          
        else
          echo "❌ 山西IPTV文件不存在"
        fi
        
        echo ""
        echo "🔍 过滤规则说明:"
        echo "1. 优先抓取 '山西联通'、'山西电信' 相关频道"
        echo "2. 抓取所有组播地址 (rtp://, udp://)"
        echo "3. 抓取所有包含 '山西'、'shanxi' 关键词的频道"
        echo "4. 自动去重和清理空行"
        
        echo ""
        echo "⏰ 下次自动执行: 每天 UTC 01:10 和 09:10 (北京时间 09:10 和 17:10)"
