name: Update Shanxi TV Source File

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 09:00 = UTC 01:00
    - cron: '10 1 * * *'
    # åŒ—äº¬æ—¶é—´ 17:00 = UTC 09:00  
    - cron: '10 9 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-shanxi-source:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
    - name: Prepare directory
      run: |
        mkdir -p shanxi
        echo "åˆ›å»º shanxi ç›®å½•..."
        
    - name: Download Shanxi TV source files
      id: download
      run: |
        echo "å¼€å§‹ä¸‹è½½å±±è¥¿ç›´æ’­æºæ–‡ä»¶..."
        
        # å®šä¹‰å¤šä¸ªå±±è¥¿ç›´æ’­æºURLï¼ˆå¯æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šï¼‰
        SHANXI_SOURCES=(
          "https://mirror.ghproxy.com/https://raw.githubusercontent.com/fanmingming/live/main/shanxi/shanxi.txt"
          "https://raw.githubusercontent.com/fanmingming/live/main/shanxi/shanxi.txt"
          "https://github.moeyy.xyz/https://raw.githubusercontent.com/fanmingming/live/main/shanxi/shanxi.txt"
          "https://raw.fastgit.org/fanmingming/live/main/shanxi/shanxi.txt"
        )
        
        LOCAL_PATH="shanxi/shanxi_tv.txt"
        TEMP_FILE="shanxi_temp.txt"
        
        # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶
        rm -f "$TEMP_FILE" "$LOCAL_PATH"
        
        echo "å°è¯•å¤šä¸ªå±±è¥¿ç›´æ’­æºåœ°å€..."
        
        for SOURCE_URL in "${SHANXI_SOURCES[@]}"; do
          echo ""
          echo "=== å°è¯•æº: $SOURCE_URL ==="
          
          # å°è¯•ä¸‹è½½
          curl -s -L \
            -o "$TEMP_FILE" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -H "Accept: */*" \
            -H "Accept-Language: zh-CN,zh;q=0.9" \
            --max-time 30 \
            "$SOURCE_URL"
            
          if [ -f "$TEMP_FILE" ] && [ -s "$TEMP_FILE" ]; then
            FILE_SIZE=$(wc -c < "$TEMP_FILE")
            echo "ä¸‹è½½å¤§å°: $FILE_SIZE å­—èŠ‚"
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ç›´æ’­æºæ–‡ä»¶
            if head -c 100 "$TEMP_FILE" | grep -q -E "#EXTM3U|#genre#|å±±è¥¿å«è§†|å¤ªåŸç”µè§†å°|http://|https://" ; then
              echo "âœ… æ‰¾åˆ°æœ‰æ•ˆçš„å±±è¥¿ç›´æ’­æº"
              
              # å¯é€‰ï¼šè¿‡æ»¤åªä¿ç•™å±±è¥¿ç›¸å…³é¢‘é“
              echo "æ­£åœ¨è¿‡æ»¤å±±è¥¿é¢‘é“..."
              
              # æ–¹æ³•1ï¼šç›´æ¥ä½¿ç”¨ä¸‹è½½çš„æ–‡ä»¶
              cp "$TEMP_FILE" "$LOCAL_PATH"
              
              # æ–¹æ³•2ï¼šæˆ–è€…è¿‡æ»¤åŒ…å«"å±±è¥¿"çš„é¢‘é“
              # grep -i "å±±è¥¿" "$TEMP_FILE" > "$LOCAL_PATH" || cp "$TEMP_FILE" "$LOCAL_PATH"
              
              echo "downloaded=true" >> $GITHUB_OUTPUT
              echo "source_url=$SOURCE_URL" >> $GITHUB_OUTPUT
              echo "method=direct_download" >> $GITHUB_OUTPUT
              break
            else
              echo "âš ï¸ ä¸‹è½½çš„æ–‡ä»¶å¯èƒ½ä¸æ˜¯ç›´æ’­æºæ ¼å¼"
              rm -f "$TEMP_FILE"
            fi
          else
            echo "âŒ ä¸‹è½½å¤±è´¥"
          fi
          
          sleep 2  # é¿å…è¯·æ±‚è¿‡å¿«
        done
        
        # å¦‚æœä»¥ä¸Šæºéƒ½å¤±è´¥ï¼Œå°è¯•å…¶ä»–å¯èƒ½çš„å±±è¥¿ç›´æ’­æº
        if [ ! -f "$LOCAL_PATH" ] || [ ! -s "$LOCAL_PATH" ]; then
          echo ""
          echo "=== å°è¯•å¤‡ç”¨å±±è¥¿ç›´æ’­æº ==="
          
          ALTERNATIVE_SOURCES=(
            "https://agit.ai/nbwzlyd/zh/raw/branch/master/shanxi.txt"
            "https://cdn.jsdelivr.net/gh/fanmingming/live@main/shanxi/shanxi.txt"
            "https://ghproxy.com/https://raw.githubusercontent.com/fanmingming/live/main/shanxi/shanxi.txt"
          )
          
          for ALT_URL in "${ALTERNATIVE_SOURCES[@]}"; do
            echo "å°è¯•å¤‡ç”¨æº: $ALT_URL"
            
            curl -s -L \
              -o "$TEMP_FILE" \
              -H "User-Agent: Mozilla/5.0" \
              --max-time 30 \
              "$ALT_URL"
              
            if [ -f "$TEMP_FILE" ] && [ -s "$TEMP_FILE" ]; then
              if head -c 100 "$TEMP_FILE" | grep -q -E "#EXTM3U|å±±è¥¿|å¤ªåŸ" ; then
                echo "âœ… ä»å¤‡ç”¨æºè·å–æˆåŠŸ"
                cp "$TEMP_FILE" "$LOCAL_PATH"
                echo "downloaded=true" >> $GITHUB_OUTPUT
                echo "source_url=$ALT_URL" >> $GITHUB_OUTPUT
                echo "method=alternative_source" >> $GITHUB_OUTPUT
                break
              fi
            fi
          done
        fi
        
        # æœ€ç»ˆæ£€æŸ¥
        if [ -f "$LOCAL_PATH" ] && [ -s "$LOCAL_PATH" ]; then
          FINAL_SIZE=$(wc -c < "$LOCAL_PATH")
          FINAL_LINES=$(wc -l < "$LOCAL_PATH")
          SHANXI_COUNT=$(grep -i "å±±è¥¿" "$LOCAL_PATH" | wc -l || echo 0)
          
          echo ""
          echo "=== æœ€ç»ˆç»“æœ ==="
          echo "æ–‡ä»¶è·¯å¾„: $LOCAL_PATH"
          echo "æ–‡ä»¶å¤§å°: $FINAL_SIZE å­—èŠ‚"
          echo "æ–‡ä»¶è¡Œæ•°: $FINAL_LINES è¡Œ"
          echo "å±±è¥¿ç›¸å…³é¢‘é“æ•°: $SHANXI_COUNT"
          
          echo "å‰3è¡Œå†…å®¹:"
          head -3 "$LOCAL_PATH"
        else
          echo ""
          echo "âš ï¸ æ‰€æœ‰ç›´æ’­æºéƒ½å¤±è´¥ï¼Œåˆ›å»ºç¤ºä¾‹æ–‡ä»¶"
          
          # åˆ›å»ºå±±è¥¿ç›´æ’­æºç¤ºä¾‹æ–‡ä»¶
          cat > "$LOCAL_PATH" << 'EOF'
#EXTM3U
#å±±è¥¿ç›´æ’­æº - è‡ªåŠ¨æ›´æ–°
#æ›´æ–°æ—¶é—´: $(date)

#å±±è¥¿å«è§†
å±±è¥¿å«è§†,http://example.com/shanxi1.m3u8

#å¤ªåŸç”µè§†å°
å¤ªåŸæ–°é—»é¢‘é“,http://example.com/taiyuan1.m3u8

#å¤‡ç”¨å±±è¥¿é¢‘é“
å±±è¥¿ç»æµé¢‘é“,http://example.com/shanxi2.m3u8
EOF
          
          # æ›¿æ¢æ—¥æœŸ
          sed -i "s/\$(date)/$(date '+%Y-%m-%d %H:%M:%S')/" "$LOCAL_PATH"
          
          echo "downloaded=true" >> $GITHUB_OUTPUT
          echo "source_url=example" >> $GITHUB_OUTPUT
          echo "method=placeholder" >> $GITHUB_OUTPUT
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f "$TEMP_FILE"
        
    - name: Process and filter Shanxi channels
      if: steps.download.outputs.downloaded == 'true'
      run: |
        echo "å¤„ç†å±±è¥¿é¢‘é“æ•°æ®..."
        
        INPUT_FILE="shanxi/shanxi_tv.txt"
        OUTPUT_FILE="shanxi/shanxi_filtered.txt"
        
        if [ ! -f "$INPUT_FILE" ]; then
          echo "âŒ è¾“å…¥æ–‡ä»¶ä¸å­˜åœ¨"
          exit 0
        fi
        
        # å¤‡ä»½åŸå§‹æ–‡ä»¶
        cp "$INPUT_FILE" "shanxi/shanxi_original.txt"
        
        echo "åŸå§‹æ–‡ä»¶ä¿¡æ¯:"
        wc -l "$INPUT_FILE"
        
        # æ–¹æ³•1ï¼šç›´æ¥ä½¿ç”¨åŸæ–‡ä»¶
        # cp "$INPUT_FILE" "$OUTPUT_FILE"
        
        # æ–¹æ³•2ï¼šæå–å±±è¥¿ç›¸å…³é¢‘é“ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        echo "æ­£åœ¨æå–å±±è¥¿ç›¸å…³é¢‘é“..."
        
        # æå–åŒ…å«å±±è¥¿ã€å¤ªåŸã€æ™‹ä¸­ã€å¤§åŒã€è¿åŸç­‰å…³é”®è¯çš„é¢‘é“
        grep -i -E "å±±è¥¿|å¤ªåŸ|æ™‹ä¸­|å¤§åŒ|è¿åŸ|é•¿æ²»|æ™‹åŸ|æœ”å·|å¿»å·|å•æ¢|é˜³æ³‰|ä¸´æ±¾" "$INPUT_FILE" > "$OUTPUT_FILE" || {
          echo "âš ï¸ è¿‡æ»¤åæ–‡ä»¶å¯èƒ½ä¸ºç©ºï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶"
          cp "$INPUT_FILE" "$OUTPUT_FILE"
        }
        
        # ç¡®ä¿æ–‡ä»¶æœ‰M3Uå¤´
        if ! head -1 "$OUTPUT_FILE" | grep -q "#EXTM3U"; then
          echo "æ·»åŠ M3Uå¤´..."
          echo "#EXTM3U" > "temp_header.txt"
          cat "$OUTPUT_FILE" >> "temp_header.txt"
          mv "temp_header.txt" "$OUTPUT_FILE"
        fi
        
        # æ·»åŠ æ³¨é‡Š
        sed -i '1a # å±±è¥¿ç”µè§†ç›´æ’­æº - è‡ªåŠ¨æŠ“å–' "$OUTPUT_FILE"
        sed -i '2a # æ›´æ–°æ—¶é—´: '"$(date '+%Y-%m-%d %H:%M:%S')" "$OUTPUT_FILE"
        
        echo ""
        echo "å¤„ç†åæ–‡ä»¶ä¿¡æ¯:"
        wc -l "$OUTPUT_FILE"
        
        # ç»Ÿè®¡ä¸åŒç±»å‹é¢‘é“
        echo ""
        echo "ğŸ“Š é¢‘é“ç»Ÿè®¡:"
        echo "å±±è¥¿å«è§†ç›¸å…³: $(grep -i "å±±è¥¿å«è§†" "$OUTPUT_FILE" | wc -l)"
        echo "å¤ªåŸé¢‘é“: $(grep -i "å¤ªåŸ" "$OUTPUT_FILE" | wc -l)"
        echo "åœ°æ–¹é¢‘é“: $(grep -i -E "å¤§åŒ|è¿åŸ|é•¿æ²»|æ™‹åŸ|æœ”å·|å¿»å·|å•æ¢|é˜³æ³‰|ä¸´æ±¾|æ™‹ä¸­" "$OUTPUT_FILE" | wc -l)"
        
        # æ›¿æ¢ä¸»æ–‡ä»¶
        mv "$OUTPUT_FILE" "$INPUT_FILE"
        
    - name: Check if file changed
      id: check-change
      if: steps.download.outputs.downloaded == 'true'
      run: |
        echo "æ£€æŸ¥å±±è¥¿ç›´æ’­æºæ–‡ä»¶å˜åŒ–..."
        
        FILE_PATH="shanxi/shanxi_tv.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨"
          echo "has_change=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # ä½¿ç”¨Gitæ£€æŸ¥æ–‡ä»¶å˜åŒ–
        if git ls-files "$FILE_PATH" >/dev/null 2>&1; then
          # æ–‡ä»¶å·²åœ¨Gitä¸­ï¼Œæ¯”è¾ƒå˜åŒ–
          git diff --quiet "$FILE_PATH" && CHANGED=false || CHANGED=true
        else
          # æ–°æ–‡ä»¶
          CHANGED=true
        fi
        
        if [ "$CHANGED" = true ]; then
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
          echo "has_change=true" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºå˜åŒ–ç»Ÿè®¡
          FILE_SIZE=$(wc -c < "$FILE_PATH")
          FILE_LINES=$(wc -l < "$FILE_PATH")
          echo "æ–°æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          echo "æ–°æ–‡ä»¶è¡Œæ•°: $FILE_LINES è¡Œ"
        else
          echo "æ–‡ä»¶æ— å˜åŒ–"
          echo "has_change=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-change.outputs.has_change == 'true'
      run: |
        echo "æäº¤å±±è¥¿ç›´æ’­æºæ›´æ–°..."
        
        FILE_PATH="shanxi/shanxi_tv.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æäº¤"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < "$FILE_PATH")
        FILE_LINES=$(wc -l < "$FILE_PATH")
        SHANXI_COUNT=$(grep -i "å±±è¥¿" "$FILE_PATH" | wc -l || echo 0)
        SOURCE="${{ steps.download.outputs.source_url }}"
        
        echo "=== æäº¤ä¿¡æ¯ ==="
        echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
        echo "æ–‡ä»¶è¡Œæ•°: $FILE_LINES è¡Œ"
        echo "å±±è¥¿é¢‘é“æ•°: $SHANXI_COUNT"
        echo "æ•°æ®æ¥æº: $SOURCE"
        
        # æ·»åŠ æ‰€æœ‰shanxiç›®å½•ä¸‹çš„æ–‡ä»¶
        git add shanxi/
        
        # æäº¤ä¿¡æ¯
        COMMIT_MSG="ğŸ® æ›´æ–°å±±è¥¿ç›´æ’­æº - $(date '+%Y-%m-%d %H:%M UTC')"
        COMMIT_MSG="$COMMIT_MSG | å¤§å°: ${FILE_SIZE}å­—èŠ‚"
        COMMIT_MSG="$COMMIT_MSG | è¡Œæ•°: ${FILE_LINES}è¡Œ"
        COMMIT_MSG="$COMMIT_MSG | å±±è¥¿é¢‘é“: ${SHANXI_COUNT}ä¸ª"
        
        if [ -n "$SOURCE" ] && [ "$SOURCE" != "example" ]; then
          COMMIT_MSG="$COMMIT_MSG | æ¥æº: $(echo $SOURCE | cut -d'/' -f3)"
        fi
        
        git commit -m "$COMMIT_MSG"
        
        echo "æ¨é€åˆ°GitHub..."
        git push
        
        echo "âœ… å±±è¥¿ç›´æ’­æºæ›´æ–°å®Œæˆ"
        
    - name: Show detailed final status
      run: |
        echo "=========================================="
        echo "      å±±è¥¿ç›´æ’­æºæ›´æ–°è¯¦ç»†æŠ¥å‘Š"
        echo "=========================================="
        
        echo "æ‰§è¡Œå®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "å¯¹åº”åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        
        echo ""
        echo "ğŸ“ Shanxiç›®å½•ç»“æ„:"
        ls -la shanxi/ 2>/dev/null || echo "shanxiç›®å½•ä¸å­˜åœ¨"
        
        echo ""
        if [ -f "shanxi/shanxi_tv.txt" ]; then
          echo "âœ… å±±è¥¿ç›´æ’­æºæ–‡ä»¶å­˜åœ¨"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          ls -lh "shanxi/shanxi_tv.txt"
          
          echo ""
          echo "ğŸ“Š å†…å®¹åˆ†æ:"
          FILE_SIZE=$(wc -c < "shanxi/shanxi_tv.txt")
          echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          
          if [ $FILE_SIZE -gt 1000 ]; then
            echo "å†…å®¹é¢„è§ˆ (å‰10è¡Œ):"
            echo "----------------------------------------"
            head -10 "shanxi/shanxi_tv.txt"
            echo "----------------------------------------"
            
            echo ""
            echo "ğŸ”¢ è¯¦ç»†ç»Ÿè®¡:"
            echo "æ€»è¡Œæ•°: $(wc -l < "shanxi/shanxi_tv.txt")"
            echo "HTTPé“¾æ¥æ•°: $(grep -c "http://" "shanxi/shanxi_tv.txt" 2>/dev/null || echo "0")"
            echo "HTTPSé“¾æ¥æ•°: $(grep -c "https://" "shanxi/shanxi_tv.txt" 2>/dev/null || echo "0")"
            echo "å±±è¥¿å«è§†é¢‘é“: $(grep -i "å±±è¥¿å«è§†" "shanxi/shanxi_tv.txt" | wc -l)"
            echo "å¤ªåŸç›¸å…³é¢‘é“: $(grep -i "å¤ªåŸ" "shanxi/shanxi_tv.txt" | wc -l)"
            echo "å…¶ä»–åœ°å¸‚é¢‘é“: $(grep -i -E "å¤§åŒ|è¿åŸ|é•¿æ²»|æ™‹åŸ|æœ”å·|å¿»å·|å•æ¢|é˜³æ³‰|ä¸´æ±¾|æ™‹ä¸­" "shanxi/shanxi_tv.txt" | wc -l)"
          else
            echo "âš ï¸ æ–‡ä»¶è¾ƒå°ï¼Œå¯èƒ½æ•°æ®ä¸å®Œæ•´"
            echo "å®Œæ•´å†…å®¹:"
            cat "shanxi/shanxi_tv.txt"
          fi
        else
          echo "âŒ å±±è¥¿ç›´æ’­æºæ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "ğŸ”„ æ›´æ–°é¢‘ç‡: æ¯å¤©2æ¬¡"
        echo "â° åŒ—äº¬æ—¶é—´ 09:00 å’Œ 17:00"
        
        echo ""
        echo "ğŸ’¡ ä½¿ç”¨è¯´æ˜:"
        echo "1. å±±è¥¿ç›´æ’­æºæ–‡ä»¶: shanxi/shanxi_tv.txt"
        echo "2. åŸå§‹å¤‡ä»½æ–‡ä»¶: shanxi/shanxi_original.txt"
        echo "3. æ”¯æŒæ‰‹åŠ¨è§¦å‘æ›´æ–°"          # åˆ›å»ºå ä½æ–‡ä»¶
          echo "# ç›´æ’­æºæ–‡ä»¶ä¸‹è½½å¤±è´¥ - $(date)" > "$LOCAL_PATH"
          echo "# è¯·æ£€æŸ¥URL: $REMOTE_URL" >> "$LOCAL_PATH"
          echo "method=failed" >> $GITHUB_OUTPUT
        fi
        
        echo "downloaded=true" >> $GITHUB_OUTPUT
        
    - name: Extract Shanxi channels
      id: extract-shanxi
      if: steps.download.outputs.downloaded == 'true'
      run: |
        echo "å¼€å§‹ç­›é€‰å±±è¥¿çœé¢‘é“..."
        
        SOURCE_FILE="tv/pllive.txt"
        SHANXI_FILE="tv/shanxi.txt"
        
        if [ ! -f "$SOURCE_FILE" ] || [ ! -s "$SOURCE_FILE" ]; then
          echo "âŒ æºæ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
          echo "shanxi_channels=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æ¸…ç©ºå±±è¥¿é¢‘é“æ–‡ä»¶
        > "$SHANXI_FILE"
        
        # æ·»åŠ æ–‡ä»¶å¤´éƒ¨ä¿¡æ¯
        echo "# Shanxi TV Channels" >> "$SHANXI_FILE"
        echo "# Extracted from: pllive.txt" >> "$SHANXI_FILE"
        echo "# Date: $(date '+%Y-%m-%d %H:%M:%S')" >> "$SHANXI_FILE"
        echo "#" >> "$SHANXI_FILE"
        
        # å®šä¹‰ç­›é€‰å…³é”®è¯ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        SHANXI_KEYWORDS=(
          "å±±è¥¿"
          "å¤ªåŸ"
          "å¤§åŒ"
          "æœ”å·"
          "å¿»å·"
          "é˜³æ³‰"
          "å•æ¢"
          "æ™‹ä¸­"
          "é•¿æ²»"
          "æ™‹åŸ"
          "ä¸´æ±¾"
          "è¿åŸ"
        )
        
        # å¤®è§†ç›¸å…³å…³é”®è¯
        CCTV_KEYWORDS=(
          "CCTV"
          "å¤®è§†"
          "ä¸­å¤®"
        )
        
        # å«è§†å…³é”®è¯
        SATELLITE_KEYWORDS=(
          "å«è§†"
          "å«è§†é«˜æ¸…"
          "å«è§†æ ‡æ¸…"
        )
        
        # ç»„æ’­å…³é”®è¯
        MULTICAST_KEYWORDS=(
          "rtp://"
          "udp://"
          "@239"
          "å±±è¥¿è”é€š"
          "å±±è¥¿ç”µä¿¡"
          "å±±è¥¿ç§»åŠ¨"
          "unicom"
          "telecom"
          "ç§»åŠ¨"
          "è”é€š"
          "ç”µä¿¡"
        )
        
        # è®¡æ•°å™¨
        CCTV_COUNT=0
        SATELLITE_COUNT=0
        SHANXI_LOCAL_COUNT=0
        MULTICAST_COUNT=0
        OTHER_COUNT=0
        
        # å¤„ç†æ–‡ä»¶ï¼ŒæŒ‰è¡Œè¯»å–
        while IFS= read -r line; do
          # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
          if [[ -z "$line" ]] || [[ "$line" == \#* ]]; then
            echo "$line" >> "$SHANXI_FILE"
            continue
          fi
            
          # ç»Ÿä¸€è½¬æ¢ä¸ºå¤§å†™è¿›è¡Œæ¯”è¾ƒï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
          line_upper=$(echo "$line" | tr '[:lower:]' '[:upper:]')
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºå±±è¥¿ç›¸å…³é¢‘é“
          is_shanxi=false
          for keyword in "${SHANXI_KEYWORDS[@]}"; do
            keyword_upper=$(echo "$keyword" | tr '[:lower:]' '[:upper:]')
            if [[ "$line_upper" == *"$keyword_upper"* ]]; then
              is_shanxi=true
              break
            fi
          done
          
          # å¦‚æœæ˜¯å±±è¥¿ç›¸å…³ï¼Œå†åˆ†ç±»
          if [ "$is_shanxi" = true ]; then
            # æ£€æŸ¥æ˜¯å¦ä¸ºå¤®è§†
            is_cctv=false
            for keyword in "${CCTV_KEYWORDS[@]}"; do
              keyword_upper=$(echo "$keyword" | tr '[:lower:]' '[:upper:]')
              if [[ "$line_upper" == *"$keyword_upper"* ]]; then
                is_cctv=true
                break
              fi
            done
            
            # æ£€æŸ¥æ˜¯å¦ä¸ºå«è§†
            is_satellite=false
            for keyword in "${SATELLITE_KEYWORDS[@]}"; do
              keyword_upper=$(echo "$keyword" | tr '[:lower:]' '[:upper:]')
              if [[ "$line_upper" == *"$keyword_upper"* ]]; then
                is_satellite=true
                break
              fi
            done
            
            # æ£€æŸ¥æ˜¯å¦ä¸ºç»„æ’­
            is_multicast=false
            for keyword in "${MULTICAST_KEYWORDS[@]}"; do
              keyword_upper=$(echo "$keyword" | tr '[:lower:]' '[:upper:]')
              if [[ "$line_upper" == *"$keyword_upper"* ]]; then
                is_multicast=true
                break
              fi
            done
            
            # åˆ†ç±»è®¡æ•°
            if [ "$is_cctv" = true ]; then
              CCTV_COUNT=$((CCTV_COUNT + 1))
              echo "# CCTVå±±è¥¿æº" >> "$SHANXI_FILE"
            elif [ "$is_satellite" = true ]; then
              SATELLITE_COUNT=$((SATELLITE_COUNT + 1))
              echo "# å«è§†å±±è¥¿æº" >> "$SHANXI_FILE"
            elif [ "$is_multicast" = true ]; then
              MULTICAST_COUNT=$((MULTICAST_COUNT + 1))
              echo "# å±±è¥¿ç»„æ’­" >> "$SHANXI_FILE"
            else
              SHANXI_LOCAL_COUNT=$((SHANXI_LOCAL_COUNT + 1))
              echo "# å±±è¥¿åœ°æ–¹å°" >> "$SHANXI_FILE"
            fi
            
            echo "$line" >> "$SHANXI_FILE"
            
          # å¦‚æœä¸æ˜¯å±±è¥¿ç›¸å…³ï¼Œä½†åŒ…å«ç»„æ’­åœ°å€ä¹Ÿä¿ç•™ï¼ˆå±±è¥¿è”é€š/ç”µä¿¡ç»„æ’­ï¼‰
          elif [[ "$line" == rtp://* ]] || [[ "$line" == udp://* ]] || [[ "$line_upper" == *239* ]]; then
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å±±è¥¿å…³é”®è¯
            is_shanxi_multicast=false
            for keyword in "${SHANXI_KEYWORDS[@]}"; do
              keyword_upper=$(echo "$keyword" | tr '[:lower:]' '[:upper:]')
              if [[ "$line_upper" == *"$keyword_upper"* ]]; then
                is_shanxi_multicast=true
                break
              fi
            done
            
            if [ "$is_shanxi_multicast" = true ]; then
              MULTICAST_COUNT=$((MULTICAST_COUNT + 1))
              echo "# å±±è¥¿ç»„æ’­" >> "$SHANXI_FILE"
              echo "$line" >> "$SHANXI_FILE"
            fi
          fi
        done < "$SOURCE_FILE"
        
        # æ·»åŠ åˆ†ç±»ç»Ÿè®¡
        echo "" >> "$SHANXI_FILE"
        echo "# é¢‘é“ç»Ÿè®¡" >> "$SHANXI_FILE"
        echo "# å¤®è§†å±±è¥¿æº: $CCTV_COUNT" >> "$SHANXI_FILE"
        echo "# å«è§†å±±è¥¿æº: $SATELLITE_COUNT" >> "$SHANXI_FILE"
        echo "# å±±è¥¿åœ°æ–¹å°: $SHANXI_LOCAL_COUNT" >> "$SHANXI_FILE"
        echo "# å±±è¥¿ç»„æ’­æº: $MULTICAST_COUNT" >> "$SHANXI_FILE"
        echo "# æ€»è®¡: $((CCTV_COUNT + SATELLITE_COUNT + SHANXI_LOCAL_COUNT + MULTICAST_COUNT))" >> "$SHANXI_FILE"
        
        TOTAL_CHANNELS=$((CCTV_COUNT + SATELLITE_COUNT + SHANXI_LOCAL_COUNT + MULTICAST_COUNT))
        
        echo "âœ… ç­›é€‰å®Œæˆ"
        echo "æºæ–‡ä»¶å¤§å°: $(wc -l < "$SOURCE_FILE") è¡Œ"
        echo "å±±è¥¿é¢‘é“æ•°: $TOTAL_CHANNELS ä¸ª"
        echo "  - å¤®è§†å±±è¥¿æº: $CCTV_COUNT"
        echo "  - å«è§†å±±è¥¿æº: $SATELLITE_COUNT"
        echo "  - å±±è¥¿åœ°æ–¹å°: $SHANXI_LOCAL_COUNT"
        echo "  - å±±è¥¿ç»„æ’­æº: $MULTICAST_COUNT"
        
        echo "shanxi_channels=$TOTAL_CHANNELS" >> $GITHUB_OUTPUT
        echo "shanxi_cctv=$CCTV_COUNT" >> $GITHUB_OUTPUT
        echo "shanxi_satellite=$SATELLITE_COUNT" >> $GITHUB_OUTPUT
        echo "shanxi_local=$SHANXI_LOCAL_COUNT" >> $GITHUB_OUTPUT
        echo "shanxi_multicast=$MULTICAST_COUNT" >> $GITHUB_OUTPUT
        
    - name: Check if files changed
      id: check-change
      if: steps.download.outputs.downloaded == 'true'
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜åŒ–..."
        
        CHANGED_FILES=()
        
        # æ£€æŸ¥åŸå§‹æ–‡ä»¶
        if [ -f "tv/pllive.txt" ]; then
          if git diff --quiet "tv/pllive.txt" 2>/dev/null; then
            echo "åŸå§‹æ–‡ä»¶æ— å˜åŒ–"
          else
            echo "åŸå§‹æ–‡ä»¶æœ‰å˜åŒ–"
            CHANGED_FILES+=("tv/pllive.txt")
          fi
        fi
        
        # æ£€æŸ¥å±±è¥¿é¢‘é“æ–‡ä»¶
        if [ -f "tv/shanxi.txt" ]; then
          if git diff --quiet "tv/shanxi.txt" 2>/dev/null; then
            echo "å±±è¥¿é¢‘é“æ–‡ä»¶æ— å˜åŒ–"
          else
            echo "å±±è¥¿é¢‘é“æ–‡ä»¶æœ‰å˜åŒ–"
            CHANGED_FILES+=("tv/shanxi.txt")
          fi
        fi
        
        if [ ${#CHANGED_FILES[@]} -eq 0 ]; then
          echo "æ²¡æœ‰æ–‡ä»¶å˜åŒ–"
          echo "has_change=false" >> $GITHUB_OUTPUT
        else
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–: ${CHANGED_FILES[*]}"
          echo "has_change=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-change.outputs.has_change == 'true'
      run: |
        echo "å‡†å¤‡æäº¤æ–‡ä»¶..."
        
        # æ·»åŠ æ‰€æœ‰å˜åŒ–çš„æ–‡ä»¶
        git add tv/
        
        # è·å–ç»Ÿè®¡ä¿¡æ¯
        TOTAL_CHANNELS="${{ steps.extract-shanxi.outputs.shanxi_channels }}"
        CCTV_COUNT="${{ steps.extract-shanxi.outputs.shanxi_cctv }}"
        SATELLITE_COUNT="${{ steps.extract-shanxi.outputs.shanxi_satellite }}"
        LOCAL_COUNT="${{ steps.extract-shanxi.outputs.shanxi_local }}"
        MULTICAST_COUNT="${{ steps.extract-shanxi.outputs.shanxi_multicast }}"
        METHOD="${{ steps.download.outputs.method }}"
        
        # æäº¤ä¿¡æ¯
        COMMIT_MSG="ğŸ“º æ›´æ–°å±±è¥¿ç›´æ’­æº - $(date '+%Y-%m-%d %H:%M UTC')"
        COMMIT_MSG="$COMMIT_MSG | æ€»è®¡: ${TOTAL_CHANNELS}é¢‘é“"
        
        if [ -n "$CCTV_COUNT" ] && [ "$CCTV_COUNT" != "" ]; then
          COMMIT_MSG="$COMMIT_MSG (å¤®è§†${CCTV_COUNT}/å«è§†${SATELLITE_COUNT}/åœ°æ–¹${LOCAL_COUNT}/ç»„æ’­${MULTICAST_COUNT})"
        fi
        
        COMMIT_MSG="$COMMIT_MSG | æ–¹æ³•: ${METHOD}"
        
        git commit -m "$COMMIT_MSG"
        
        echo "æ¨é€åˆ°GitHub..."
        git push
        
        echo "âœ… æäº¤å¹¶æ¨é€å®Œæˆ"
        
    - name: Show detailed final status
      run: |
        echo "=========================================="
        echo "          å±±è¥¿é¢‘é“ç­›é€‰æŠ¥å‘Š"
        echo "=========================================="
        
        echo "æ‰§è¡Œå®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "å¯¹åº”åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        
        echo ""
        echo "ğŸ“ æ–‡ä»¶åˆ—è¡¨:"
        ls -lh tv/*.txt 2>/dev/null || echo "æ²¡æœ‰tvç›®å½•"
        
        echo ""
        if [ -f "tv/pllive.txt" ]; then
          echo "ğŸ“¦ åŸå§‹æ–‡ä»¶ä¿¡æ¯:"
          ORIG_SIZE=$(wc -c < "tv/pllive.txt")
          ORIG_LINES=$(wc -l < "tv/pllive.txt" 2>/dev/null || echo "0")
          echo "å¤§å°: $ORIG_SIZE å­—èŠ‚, è¡Œæ•°: $ORIG_LINES"
        fi
        
        echo ""
        if [ -f "tv/shanxi.txt" ]; then
          echo "ğŸ”ï¸ å±±è¥¿é¢‘é“æ–‡ä»¶ä¿¡æ¯:"
          SHANXI_SIZE=$(wc -c < "tv/shanxi.txt")
          SHANXI_LINES=$(wc -l < "tv/shanxi.txt" 2>/dev/null || echo "0")
          echo "å¤§å°: $SHANXI_SIZE å­—èŠ‚, è¡Œæ•°: $SHANXI_LINES"
          
          echo ""
          echo "ğŸ“Š é¢‘é“åˆ†ç±»é¢„è§ˆ:"
          echo "----------------------------------------"
          
          # æ˜¾ç¤ºå„åˆ†ç±»ç¤ºä¾‹
          for category in "CCTVå±±è¥¿æº" "å«è§†å±±è¥¿æº" "å±±è¥¿åœ°æ–¹å°" "å±±è¥¿ç»„æ’­"; do
            echo "ã€$categoryã€‘:"
            grep -A1 "# $category" "tv/shanxi.txt" | head -4 | grep -v "^# " | head -2
            echo ""
          done
          
          echo "----------------------------------------"
          
          # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
          echo ""
          echo "ğŸ”¢ è¯¦ç»†ç»Ÿè®¡:"
          grep "^# é¢‘é“ç»Ÿè®¡" -A5 "tv/shanxi.txt" | tail -5
        else
          echo "âŒ å±±è¥¿é¢‘é“æ–‡ä»¶æœªç”Ÿæˆ"
        fi
        
        echo ""
        echo "ğŸ” å…³é”®è¯ç­›é€‰è¯´æ˜:"
        echo "1. å±±è¥¿åœ°åŒº: å±±è¥¿ã€å¤ªåŸã€å¤§åŒã€æœ”å·ã€å¿»å·ã€é˜³æ³‰ã€å•æ¢ã€æ™‹ä¸­ã€é•¿æ²»ã€æ™‹åŸã€ä¸´æ±¾ã€è¿åŸ"
        echo "2. å¤®è§†: CCTVã€å¤®è§†ã€ä¸­å¤®"
        echo "3. å«è§†: å«è§†ã€å«è§†é«˜æ¸…ã€å«è§†æ ‡æ¸…"
        echo "4. ç»„æ’­: rtp://ã€udp://ã€@239ã€å±±è¥¿è”é€šã€å±±è¥¿ç”µä¿¡ã€å±±è¥¿ç§»åŠ¨"
        
        echo ""
        echo "â° ä¸‹æ¬¡è‡ªåŠ¨æ‰§è¡Œ: UTC 01:10 å’Œ 09:10 (åŒ—äº¬æ—¶é—´ 09:10 å’Œ 17:10)"        
        # ç»Ÿè®¡å„ç±»é¢‘é“æ•°é‡
        UNICOM_COUNT=$(grep -c -i "è”é€š" "$FILE_PATH" 2>/dev/null || echo 0)
        TELECOM_COUNT=$(grep -c -i "ç”µä¿¡" "$FILE_PATH" 2>/dev/null || echo 0)
        MOBILE_COUNT=$(grep -c -i "ç§»åŠ¨" "$FILE_PATH" 2>/dev/null || echo 0)
        MULTICAST_COUNT=$(grep -c -E "rtp://|udp://" "$FILE_PATH" 2>/dev/null || echo 0)
        SHANXI_COUNT=$(grep -c -i "å±±è¥¿" "$FILE_PATH" 2>/dev/null || echo 0)
        
        echo "=== æäº¤ä¿¡æ¯ ==="
        echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
        echo "æ–‡ä»¶è¡Œæ•°: $FILE_LINES è¡Œ"
        echo "å±±è¥¿è”é€š: $UNICOM_COUNT ä¸ª"
        echo "å±±è¥¿ç”µä¿¡: $TELECOM_COUNT ä¸ª"
        echo "å±±è¥¿ç§»åŠ¨: $MOBILE_COUNT ä¸ª"
        echo "ç»„æ’­åœ°å€: $MULTICAST_COUNT ä¸ª"
        echo "å±±è¥¿ç›¸å…³: $SHANXI_COUNT ä¸ª"
        
        git add "$FILE_PATH"
        
        # æäº¤ä¿¡æ¯
        COMMIT_MSG="ğŸ“¡ æ›´æ–°å±±è¥¿IPTVç»„æ’­æº - $(date '+%Y-%m-%d %H:%M UTC')"
        COMMIT_MSG="$COMMIT_MSG | å¤§å°: ${FILE_SIZE}å­—èŠ‚"
        
        if [ $FILE_LINES -gt 0 ]; then
          COMMIT_MSG="$COMMIT_MSG | è¡Œæ•°: ${FILE_LINES}è¡Œ"
        fi
        
        if [ $SHANXI_COUNT -gt 0 ]; then
          COMMIT_MSG="$COMMIT_MSG | å±±è¥¿é¢‘é“: ${SHANXI_COUNT}ä¸ª"
        fi
        
        if [ $MULTICAST_COUNT -gt 0 ]; then
          COMMIT_MSG="$COMMIT_MSG | ç»„æ’­: ${MULTICAST_COUNT}ä¸ª"
        fi
        
        git commit -m "$COMMIT_MSG"
        
        echo "æ¨é€åˆ°GitHub..."
        git push
        
        echo "âœ… æäº¤å¹¶æ¨é€å®Œæˆ"
        
    - name: Show detailed final status
      run: |
        echo "=========================================="
        echo "          å±±è¥¿IPTVæºæ›´æ–°æŠ¥å‘Š"
        echo "=========================================="
        
        echo "æ‰§è¡Œå®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "å¯¹åº”åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        
        echo ""
        if [ -f "tv/shanxi_iptv.txt" ]; then
          echo "âœ… å±±è¥¿IPTVæ–‡ä»¶å­˜åœ¨"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          ls -lh "tv/shanxi_iptv.txt"
          
          echo ""
          echo "ğŸ“Š å†…å®¹åˆ†æ:"
          FILE_SIZE=$(wc -c < "tv/shanxi_iptv.txt")
          FILE_LINES=$(wc -l < "tv/shanxi_iptv.txt")
          echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          echo "æ–‡ä»¶è¡Œæ•°: $FILE_LINES è¡Œ"
          
          echo ""
          echo "ğŸ”¢ é¢‘é“ç»Ÿè®¡:"
          echo "å±±è¥¿è”é€š: $(grep -c -i "è”é€š" "tv/shanxi_iptv.txt") ä¸ª"
          echo "å±±è¥¿ç”µä¿¡: $(grep -c -i "ç”µä¿¡" "tv/shanxi_iptv.txt") ä¸ª"
          echo "å±±è¥¿ç§»åŠ¨: $(grep -c -i "ç§»åŠ¨" "tv/shanxi_iptv.txt") ä¸ª"
          echo "ç»„æ’­åœ°å€: $(grep -c -E "rtp://|udp://" "tv/shanxi_iptv.txt") ä¸ª"
          echo "æ€»å±±è¥¿ç›¸å…³: $(grep -c -i "å±±è¥¿" "tv/shanxi_iptv.txt") ä¸ª"
          
          echo ""
          echo "ğŸ“º å†…å®¹é¢„è§ˆ (å‰15è¡Œ):"
          echo "----------------------------------------"
          head -15 "tv/shanxi_iptv.txt"
          echo "----------------------------------------"
          
          echo ""
          echo "ğŸ“¡ ç»„æ’­åœ°å€ç¤ºä¾‹:"
          grep -E "rtp://|udp://" "tv/shanxi_iptv.txt" | head -5 || echo "æœªæ‰¾åˆ°ç»„æ’­åœ°å€"
          
        else
          echo "âŒ å±±è¥¿IPTVæ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "ğŸ” è¿‡æ»¤è§„åˆ™è¯´æ˜:"
        echo "1. ä¼˜å…ˆæŠ“å– 'å±±è¥¿è”é€š'ã€'å±±è¥¿ç”µä¿¡' ç›¸å…³é¢‘é“"
        echo "2. æŠ“å–æ‰€æœ‰ç»„æ’­åœ°å€ (rtp://, udp://)"
        echo "3. æŠ“å–æ‰€æœ‰åŒ…å« 'å±±è¥¿'ã€'shanxi' å…³é”®è¯çš„é¢‘é“"
        echo "4. è‡ªåŠ¨å»é‡å’Œæ¸…ç†ç©ºè¡Œ"
        
        echo ""
        echo "â° ä¸‹æ¬¡è‡ªåŠ¨æ‰§è¡Œ: æ¯å¤© UTC 01:10 å’Œ 09:10 (åŒ—äº¬æ—¶é—´ 09:10 å’Œ 17:10)"
