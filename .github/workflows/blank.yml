name: Update Shanxi TV Source with IPTV-Spider

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 09:00 = UTC 01:00
    - cron: '10 1 * * *'
    # åŒ—äº¬æ—¶é—´ 17:00 = UTC 09:00  
    - cron: '10 9 * * *'
  workflow_dispatch:
    inputs:
      spider_type:
        description: 'çˆ¬è™«ç±»å‹'
        required: false
        default: 'shanxi'
        type: choice
        options:
          - shanxi
          - all
          - test

permissions:
  contents: write

jobs:
  iptv-spider-shanxi:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
    - name: Prepare directory
      run: |
        mkdir -p shanxi
        mkdir -p data
        echo "åˆ›å»ºå·¥ä½œç›®å½•..."
        
    - name: Run IPTV Spider for Shanxi
      id: run-spider
      run: |
        echo "å¼€å§‹è¿è¡ŒIPTVçˆ¬è™«è·å–å±±è¥¿ç›´æ’­æº..."
        
        # æ–¹æ³•1ï¼šä½¿ç”¨Dockerï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if command -v docker &> /dev/null; then
          echo "æ£€æµ‹åˆ°Dockerï¼Œå°è¯•ä½¿ç”¨Dockerè¿è¡Œçˆ¬è™«..."
          
          # å°è¯•æ‹‰å–é•œåƒ
          docker pull ghcr.io/cqshushu/iptv-spider:latest || echo "Dockeræ‹‰å–å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•"
          
          # è¿è¡Œçˆ¬è™«ï¼ŒæŒ‡å®šå±±è¥¿åœ°åŒº
          docker run --rm \
            -v $(pwd)/data:/app/data \
            ghcr.io/cqshushu/iptv-spider:latest \
            --type "${{ github.event.inputs.spider_type || 'shanxi' }}" || true
        else
          echo "Dockerä¸å¯ç”¨ï¼Œè·³è¿‡Dockeræ–¹å¼"
        fi
        
        # æ–¹æ³•2ï¼šç›´æ¥ä½¿ç”¨Pythonçˆ¬è™«è„šæœ¬
        echo ""
        echo "=== æ–¹æ³•2ï¼šä½¿ç”¨Pythonè„šæœ¬çˆ¬å– ==="
        
        # åˆ›å»ºè‡ªå®šä¹‰çš„å±±è¥¿ç›´æ’­æºçˆ¬è™«è„šæœ¬
        cat > spider_shanxi.py << 'EOF'
#!/usr/bin/env python3
"""
å±±è¥¿ç›´æ’­æºçˆ¬è™«è„šæœ¬
"""

import requests
import json
import time
import os
from datetime import datetime

def fetch_shanxi_sources():
    """è·å–å±±è¥¿ç›´æ’­æº"""
    print("å¼€å§‹çˆ¬å–å±±è¥¿ç›´æ’­æº...")
    
    # å¤šä¸ªå±±è¥¿ç›´æ’­æºURL
    sources = [
        # GitHubä¸Šçš„å±±è¥¿ç›´æ’­æº
        "https://raw.githubusercontent.com/fanmingming/live/main/shanxi/shanxi.txt",
        "https://cdn.jsdelivr.net/gh/fanmingming/live@main/shanxi/shanxi.txt",
        
        # å…¶ä»–å¯èƒ½çš„å±±è¥¿ç›´æ’­æº
        "https://raw.githubusercontent.com/iptv-org/iptv/master/regions/cn.m3u",
        "https://raw.githubusercontent.com/zhanghongchen/iptv/main/IPTV.m3u",
    ]
    
    all_channels = []
    
    for url in sources:
        try:
            print(f"æ­£åœ¨è·å–: {url}")
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                'Accept-Language': 'zh-CN,zh;q=0.9',
            }
            
            response = requests.get(url, headers=headers, timeout=30)
            
            if response.status_code == 200:
                content = response.text
                
                # å¤„ç†M3Uæ ¼å¼
                lines = content.split('\n')
                for i, line in enumerate(lines):
                    line = line.strip()
                    if line.startswith('#EXTINF:'):
                        # æå–é¢‘é“ä¿¡æ¯
                        if i + 1 < len(lines):
                            channel_info = line
                            channel_url = lines[i + 1].strip()
                            
                            # æ£€æŸ¥æ˜¯å¦æ˜¯å±±è¥¿ç›¸å…³é¢‘é“
                            if any(keyword in channel_info.lower() for keyword in ['å±±è¥¿', 'shanxi', 'å¤ªåŸ', 'taiyuan']):
                                all_channels.append(f"{channel_info}\n{channel_url}")
                
                print(f"ä» {url} è·å–æˆåŠŸï¼Œæ‰¾åˆ° {len([c for c in all_channels if 'å±±è¥¿' in c])} ä¸ªå±±è¥¿é¢‘é“")
            else:
                print(f"è·å–å¤±è´¥: HTTP {response.status_code}")
                
        except Exception as e:
            print(f"è·å– {url} æ—¶å‡ºé”™: {e}")
        
        time.sleep(1)  # é¿å…è¯·æ±‚è¿‡å¿«
    
    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å±±è¥¿é¢‘é“ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®
    if not all_channels:
        print("æœªæ‰¾åˆ°å±±è¥¿é¢‘é“ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®...")
        all_channels = [
            '#EXTINF:-1 tvg-id="ShanxiTV" tvg-name="å±±è¥¿å«è§†" tvg-logo="https://example.com/shanxi.png" group-title="å±±è¥¿",å±±è¥¿å«è§†',
            'http://[2409:8087:2001:20:2800:0:df6e:eb26]/wh7f454c46tw2870272495_1939017856/ott.mobaibox.com/PLTV/3/224/3221228204/index.m3u8',
            '#EXTINF:-1 tvg-id="TaiyuanTV" tvg-name="å¤ªåŸæ–°é—»" tvg-logo="https://example.com/taiyuan.png" group-title="å±±è¥¿",å¤ªåŸæ–°é—»ç»¼åˆ',
            'http://[2409:8087:2001:20:2800:0:df6e:eb26]/wh7f454c46tw2870272495_1939017857/ott.mobaibox.com/PLTV/3/224/3221228205/index.m3u8',
        ]
    
    # ç”ŸæˆM3Uæ–‡ä»¶å†…å®¹
    m3u_content = "#EXTM3U\n"
    m3u_content += "# å±±è¥¿ç”µè§†ç›´æ’­æº\n"
    m3u_content += f"# æ›´æ–°æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
    m3u_content += f"# é¢‘é“æ€»æ•°: {len(all_channels)}\n"
    m3u_content += "\n"
    
    for channel in all_channels:
        m3u_content += channel + "\n"
    
    return m3u_content

def main():
    # åˆ›å»ºè¾“å‡ºç›®å½•
    os.makedirs('data', exist_ok=True)
    
    # è·å–å±±è¥¿ç›´æ’­æº
    shanxi_content = fetch_shanxi_sources()
    
    # ä¿å­˜æ–‡ä»¶
    output_file = 'data/shanxi_tv.m3u'
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(shanxi_content)
    
    # åŒæ—¶ä¿å­˜ä¸ºtxtæ ¼å¼
    txt_file = 'shanxi/shanxi_tv.txt'
    os.makedirs('shanxi', exist_ok=True)
    with open(txt_file, 'w', encoding='utf-8') as f:
        f.write(shanxi_content)
    
    print(f"\nâœ… å±±è¥¿ç›´æ’­æºå·²ä¿å­˜:")
    print(f"   - {output_file}")
    print(f"   - {txt_file}")
    
    # ç»Ÿè®¡ä¿¡æ¯
    lines = shanxi_content.count('\n')
    channels = shanxi_content.count('#EXTINF:')
    print(f"ğŸ“Š ç»Ÿè®¡: {channels} ä¸ªé¢‘é“, {lines} è¡Œ")

if __name__ == '__main__':
    main()
EOF
        
        # è¿è¡ŒPythonçˆ¬è™«
        python3 spider_shanxi.py
        
        # æ–¹æ³•3ï¼šä½¿ç”¨curlç›´æ¥è·å–å¹¶å¤„ç†
        if [ ! -f "shanxi/shanxi_tv.txt" ] || [ ! -s "shanxi/shanxi_tv.txt" ]; then
          echo ""
          echo "=== æ–¹æ³•3ï¼šç›´æ¥è·å–å±±è¥¿ç›´æ’­æº ==="
          
          # ç›´æ¥è·å–fanmingmingçš„å±±è¥¿ç›´æ’­æº
          curl -s -L \
            -H "User-Agent: Mozilla/5.0" \
            "https://raw.githubusercontent.com/fanmingming/live/main/shanxi/shanxi.txt" \
            -o "shanxi/shanxi_tv.txt"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
          if [ -f "shanxi/shanxi_tv.txt" ]; then
            SIZE=$(wc -c < "shanxi/shanxi_tv.txt")
            if [ $SIZE -gt 100 ]; then
              echo "âœ… ç›´æ¥è·å–æˆåŠŸ: $SIZE å­—èŠ‚"
              
              # æ·»åŠ æ—¶é—´æˆ³
              echo -e "# æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\n" | cat - "shanxi/shanxi_tv.txt" > temp.txt
              mv temp.txt "shanxi/shanxi_tv.txt"
            fi
          fi
        fi
        
        # æœ€ç»ˆéªŒè¯
        if [ -f "shanxi/shanxi_tv.txt" ] && [ -s "shanxi/shanxi_tv.txt" ]; then
          FILE_SIZE=$(wc -c < "shanxi/shanxi_tv.txt")
          FILE_LINES=$(wc -l < "shanxi/shanxi_tv.txt")
          SHANXI_COUNT=$(grep -i "å±±è¥¿" "shanxi/shanxi_tv.txt" | wc -l || echo 0)
          
          echo ""
          echo "=== çˆ¬å–ç»“æœ ==="
          echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          echo "æ–‡ä»¶è¡Œæ•°: $FILE_LINES è¡Œ"
          echo "å±±è¥¿ç›¸å…³é¢‘é“: $SHANXI_COUNT ä¸ª"
          
          echo "downloaded=true" >> $GITHUB_OUTPUT
          echo "method=iptv_spider" >> $GITHUB_OUTPUT
          echo "channels=$SHANXI_COUNT" >> $GITHUB_OUTPUT
        else
          echo "âŒ çˆ¬å–å¤±è´¥"
          echo "downloaded=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Process and optimize Shanxi sources
      if: steps.run-spider.outputs.downloaded == 'true'
      run: |
        echo "å¤„ç†å¹¶ä¼˜åŒ–å±±è¥¿ç›´æ’­æº..."
        
        INPUT_FILE="shanxi/shanxi_tv.txt"
        OUTPUT_FILE="shanxi/shanxi_optimized.txt"
        
        if [ ! -f "$INPUT_FILE" ]; then
          echo "è¾“å…¥æ–‡ä»¶ä¸å­˜åœ¨"
          exit 0
        fi
        
        # å¤‡ä»½åŸå§‹æ–‡ä»¶
        cp "$INPUT_FILE" "shanxi/shanxi_raw_$(date +%Y%m%d_%H%M%S).txt"
        
        echo "åŸå§‹æ–‡ä»¶ä¿¡æ¯:"
        wc -l "$INPUT_FILE"
        
        # å¤„ç†æ–‡ä»¶ï¼šç¡®ä¿M3Uæ ¼å¼æ­£ç¡®
        echo "æ­£åœ¨ä¼˜åŒ–æ–‡ä»¶æ ¼å¼..."
        
        # è¯»å–æ–‡ä»¶
        CONTENT=$(cat "$INPUT_FILE")
        
        # ç¡®ä¿æœ‰M3Uå¤´
        if [[ ! "$CONTENT" =~ "#EXTM3U" ]]; then
          CONTENT="#EXTM3U\n# å±±è¥¿ç”µè§†ç›´æ’­æº - ä¼˜åŒ–ç‰ˆ\n$CONTENT"
        fi
        
        # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
        TOTAL_CHANNELS=$(echo "$CONTENT" | grep -c "#EXTINF:" || echo 0)
        SHANXI_CHANNELS=$(echo "$CONTENT" | grep -i -c "å±±è¥¿" || echo 0)
        
        # ç”Ÿæˆä¼˜åŒ–ç‰ˆå†…å®¹
        cat > "$OUTPUT_FILE" << EOF
#EXTM3U x-tvg-url="https://github.com/$(echo "$GITHUB_REPOSITORY" | tr '/' '-')/shanxi"
# å±±è¥¿ç”µè§†ç›´æ’­æº - è‡ªåŠ¨æ›´æ–°
# æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
# é¢‘é“æ€»æ•°: $TOTAL_CHANNELS
# å±±è¥¿é¢‘é“: $SHANXI_CHANNELS
# æ•°æ®æ¥æº: IPTV Spider + GitHub Actions
# é¡¹ç›®åœ°å€: https://github.com/$GITHUB_REPOSITORY

$(echo "$CONTENT" | grep -v "^#EXTM3U" | grep -v "^# å±±è¥¿ç”µè§†ç›´æ’­æº")
EOF
        
        # ç§»åŠ¨å›ä¸»æ–‡ä»¶
        mv "$OUTPUT_FILE" "$INPUT_FILE"
        
        echo "âœ… ä¼˜åŒ–å®Œæˆ"
        echo "é¢‘é“ç»Ÿè®¡:"
        echo "  - æ€»é¢‘é“æ•°: $TOTAL_CHANNELS"
        echo "  - å±±è¥¿é¢‘é“æ•°: $SHANXI_CHANNELS"
        
    - name: Create Shanxi TV index
      run: |
        echo "åˆ›å»ºå±±è¥¿ç›´æ’­æºç´¢å¼•..."
        
        cat > shanxi/README.md << 'EOF'
# å±±è¥¿ç”µè§†ç›´æ’­æº

æœ¬ç›®å½•åŒ…å«è‡ªåŠ¨æ›´æ–°çš„å±±è¥¿åœ°åŒºç”µè§†ç›´æ’­æºã€‚

## æ–‡ä»¶è¯´æ˜

- `shanxi_tv.txt` - ä¸»ç›´æ’­æºæ–‡ä»¶ (M3Uæ ¼å¼)
- `shanxi_raw_*.txt` - åŸå§‹æ•°æ®å¤‡ä»½
- `README.md` - è¯´æ˜æ–‡æ¡£

## ä½¿ç”¨æ–¹å¼

### 1. ç›´æ¥ä½¿ç”¨
